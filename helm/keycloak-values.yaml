# Keycloak Helm values file for identity deployment
# This file is used by the identity-deploy-and-handover.yml playbook
# to deploy Keycloak with PostgreSQL on the infra node (control-plane)
#
# ============================================================
# SECURITY CRITICAL: Replace all CHANGEME passwords below with
# strong, randomly generated passwords before deployment.
# Use: openssl rand -base64 32
# Store passwords securely (e.g., password manager, vault)
# ============================================================
#
# STORAGE CONFIGURATION:
# The identity-deploy-and-handover.yml playbook creates:
# - A 'manual' StorageClass for manual PV provisioning
# - A PersistentVolume (keycloak-postgresql-pv) at /srv/monitoring-data/postgresql
# This resolves the "PVC data-keycloak-postgresql-0 Pending" issue by providing
# storage for the PostgreSQL database used by Keycloak.

replicaCount: 1

# Ensure node scheduling is set at the root level
nodeSelector:
  node-role.kubernetes.io/control-plane: ""

tolerations:
- key: node-role.kubernetes.io/control-plane
  operator: Exists
  effect: NoSchedule

keycloak:
  adminUser: "admin"
  adminPassword: "admin123"
  extraEnv:
    - name: DB_VENDOR
      value: postgres
    - name: DB_ADDR
      value: "keycloak-postgresql"
    - name: DB_PORT
      value: "5432"
    - name: DB_DATABASE
      value: "keycloak"
    - name: DB_USER
      value: "keycloak"
    - name: DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: keycloak-postgresql
          key: postgresql-password
  livenessProbe:
    httpGet:
      path: /health/live
      port: http
      scheme: HTTP
    initialDelaySeconds: 120
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 10
    successThreshold: 1
  readinessProbe:
    httpGet:
      path: /health/ready
      port: http
      scheme: HTTP
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 2
    failureThreshold: 10
    successThreshold: 1
  startupProbe:
    httpGet:
      path: /health/started
      port: http
      scheme: HTTP
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 2
    failureThreshold: 90
    successThreshold: 1
