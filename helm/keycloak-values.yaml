# Keycloak Helm values file for identity deployment
# This file is used by the identity-deploy-and-handover.yml playbook
# to deploy Keycloak with PostgreSQL on the infra node (control-plane)
#
# ============================================================
# SECURITY CRITICAL: Replace all CHANGEME passwords below with
# strong, randomly generated passwords before deployment.
# Use: openssl rand -base64 32
# Store passwords securely (e.g., password manager, vault)
# ============================================================
#
# STORAGE CONFIGURATION:
# The identity-deploy-and-handover.yml playbook creates:
# - A 'manual' StorageClass for manual PV provisioning
# - A PersistentVolume (keycloak-postgresql-pv) at /srv/monitoring-data/postgresql
# This resolves the "PVC data-keycloak-postgresql-0 Pending" issue by providing
# storage for the PostgreSQL database used by Keycloak.

replicaCount: 1

# Admin credentials (replace before installing in production)
keycloakAdminUser: "admin"
keycloakAdminPassword: "admin123"

# Database configuration for Bitnami Keycloak chart
extraEnvVars:
  - name: KEYCLOAK_DATABASE_HOST
    value: "keycloak-postgresql"
  - name: KEYCLOAK_DATABASE_PORT_NUMBER
    value: "5432"
  - name: KEYCLOAK_DATABASE_NAME
    value: "keycloak"
  - name: KEYCLOAK_DATABASE_USER
    value: "keycloak"
  - name: KEYCLOAK_DATABASE_PASSWORD
    valueFrom:
      secretKeyRef:
        name: keycloak-postgresql
        key: postgresql-password

# Health probes using Keycloak's dedicated endpoints
livenessProbe:
  httpGet:
    path: /health/live
    port: http
    scheme: HTTP
  initialDelaySeconds: 120  # Keycloak takes ~2 minutes to fully start
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 10
  successThreshold: 1

readinessProbe:
  httpGet:
    path: /health/ready
    port: http
    scheme: HTTP
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 2
  failureThreshold: 10
  successThreshold: 1

startupProbe:
  httpGet:
    path: /health/started  # KEY FIX: Use the startup health endpoint
    port: http
    scheme: HTTP
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 2
  failureThreshold: 90  # 90 * 10s = 15 minutes max startup time
  successThreshold: 1
