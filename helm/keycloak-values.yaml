# Keycloak Helm values file for identity deployment
# This file is used by the identity-deploy-and-handover.yml playbook
# to deploy Keycloak with PostgreSQL on the infra node (control-plane)
#
# STORAGE CONFIGURATION:
# The identity-deploy-and-handover.yml playbook creates:
# - A 'manual' StorageClass for manual PV provisioning
# - A PersistentVolume (keycloak-postgresql-pv) at /srv/identity_data/postgresql
# This resolves the "PVC data-keycloak-postgresql-0 Pending" issue by providing
# storage for the PostgreSQL database used by Keycloak.

replicaCount: 1

# Admin credentials (replace before installing in production)
keycloak:
  adminUser: "admin"
  adminPassword: "CHANGEME_ADMIN_PASSWORD"

# Service exposure
service:
  type: ClusterIP
  port: 8080

# Use PostgreSQL (recommended for production)
database:
  vendor: postgres

# PostgreSQL subchart configuration
postgresql:
  enabled: true
  auth:
    username: keycloak
    password: "CHANGEME_DB_PASSWORD"
    database: keycloak
  # Force the use of a stable, known-good PostgreSQL image to avoid
  # registry issues, rate limiting, or missing Bitnami tags
  image:
    registry: docker.io
    repository: postgres
    tag: "11"
    pullPolicy: IfNotPresent
  primary:
    persistence:
      enabled: true
      storageClass: "manual"  # Use the manual StorageClass created by the playbook
      size: 10Gi
  # If you need to authenticate to Docker Hub (or another registry), create
  # a docker-registry secret and uncomment/configure imagePullSecrets:
  # imagePullSecrets:
  #   - name: regcred
  #
  # To create the secret, run:
  # kubectl create secret docker-registry regcred \
  #   --docker-server=https://index.docker.io/v1/ \
  #   --docker-username=<user> --docker-password=<pass> --docker-email=<email> -n identity

# Persistence for Keycloak itself (themes, providers, etc)
persistence:
  enabled: false
  size: 10Gi

# Node scheduling: The playbook will set nodeSelector via Helm --set flags
# to ensure Keycloak and PostgreSQL run on the infra node (control-plane).
# You can also configure them here:
#
# keycloak:
#   nodeSelector:
#     kubernetes.io/hostname: your-masternode-hostname
#
# postgresql:
#   nodeSelector:
#     kubernetes.io/hostname: your-masternode-hostname

# Ingress (optional) - configure your ingress controller and host
ingress:
  enabled: false
  annotations: {}
  hosts:
    - host: keycloak.vmstation.local
      paths:
        - /
  tls: []

# FreeIPA / LDAP federation placeholders - configure after Keycloak is up
# Example values for the Keycloak LDAP federation provider - this file does NOT
# configure federation automatically; use Keycloak UI or API to add LDAP provider.
freeipa:
  ldapUrl: "ldap://masternode.vmstation.local"
  bindDn: "uid=admin,cn=users,cn=accounts,dc=vmstation,dc=local"
  bindCredential: "CHANGEME_LDAP_BIND_PASSWORD"
  usersDn: "cn=users,cn=accounts,dc=vmstation,dc=local"
  searchScope: 1

# Additional flags
proxyAddressForwarding: true

# Resource requests/limits (tune for your environment)
resources:
  requests:
    cpu: "100m"
    memory: "256Mi"
  limits:
    cpu: "500m"
    memory: "1Gi"
