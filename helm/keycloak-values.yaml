# Keycloak Helm values file for identity deployment
# This file is used by the identity-deploy-and-handover.yml playbook
# to deploy Keycloak with PostgreSQL on the infra node (control-plane)
#
# ============================================================
# SECURITY CRITICAL: Replace all CHANGEME passwords below with
# strong, randomly generated passwords before deployment.
# Use: openssl rand -base64 32
# Store passwords securely (e.g., password manager, vault)
# ============================================================
#
# STORAGE CONFIGURATION:
# The identity-deploy-and-handover.yml playbook creates:
# - A 'manual' StorageClass for manual PV provisioning
# - A PersistentVolume (keycloak-postgresql-pv) at /srv/monitoring-data/postgresql
# This resolves the "PVC data-keycloak-postgresql-0 Pending" issue by providing
# storage for the PostgreSQL database used by Keycloak.

replicaCount: 1

# Admin credentials (replace before installing in production)
keycloak:
  adminUser: "admin"
  adminPassword: "CHANGEME_ADMIN_PASSWORD"
  extraEnv:
    - name: DB_VENDOR
      value: postgres
    - name: DB_ADDR
      value: keycloak-postgresql
    - name: DB_PORT
      value: "5432"
    - name: DB_DATABASE
      value: keycloak
    - name: DB_USER
      value: keycloak
    - name: DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: keycloak-postgresql
          key: postgresql-password

# Schedule Keycloak on control-plane node only (always on)
nodeSelector:
  node-role.kubernetes.io/control-plane: ""

tolerations:
- key: node-role.kubernetes.io/control-plane
  operator: Exists
  effect: NoSchedule

# Service exposure
service:
  type: ClusterIP
  port: 8080

# Use PostgreSQL (recommended for production)
# Note: Database connection is configured via extraEnv above using secretKeyRef
database:
  vendor: postgres
  hostname: keycloak-postgresql
  port: 5432
  database: keycloak
  username: keycloak
  # Password is configured via DB_PASSWORD env var with secretKeyRef above
  password: ""

# PostgreSQL subchart configuration (disabled - we use standalone StatefulSet)
# Note: We use a standalone PostgreSQL StatefulSet, not this subchart
postgresql:
  enabled: false
  auth:
    username: keycloak
    password: ""  # Not used - standalone PostgreSQL uses keycloak-postgresql secret
    database: keycloak
  # Force the use of a stable, known-good PostgreSQL image to avoid
  # registry issues, rate limiting, or missing Bitnami tags
  image:
    registry: docker.io
    repository: postgres
    tag: "11"
    pullPolicy: IfNotPresent
  # Disable volumePermissions since the playbook handles directory ownership
  # The playbook pre-creates the hostPath with correct UID/GID (999:999)
  volumePermissions:
    enabled: false
  # The postgres:11 image runs as root initially then switches to postgres (UID 999).
  # Don't set runAsUser/fsGroup - let the image handle user switching.
  # NOTE: If changing the PostgreSQL image, verify the user ID and update both
  # postgresql_uid/postgresql_gid in the playbook.
  securityContext: {}
  primary:
    persistence:
      enabled: true
      storageClass: "manual"  # Use the manual StorageClass created by the playbook
      size: 10Gi
  # If you need to authenticate to Docker Hub (or another registry), create
  # a docker-registry secret and uncomment/configure imagePullSecrets:
  # imagePullSecrets:
  #   - name: regcred
  #
  # To create the secret, run:
  # kubectl create secret docker-registry regcred \
  #   --docker-server=https://index.docker.io/v1/ \
  #   --docker-username=<user> --docker-password=<pass> --docker-email=<email> -n identity

# Persistence for Keycloak itself (themes, providers, etc)
persistence:
  enabled: false
  size: 10Gi

# Node scheduling: nodeSelector and tolerations are configured at the root level
# above to ensure Keycloak runs on the control-plane node (masternode).
# PostgreSQL scheduling is configured in its separate StatefulSet manifest.

# Ingress (optional) - configure your ingress controller and host
ingress:
  enabled: false
  annotations: {}
  hosts:
    - host: keycloak.vmstation.local
      paths:
        - /
  tls: []

# FreeIPA / LDAP federation placeholders - configure after Keycloak is up
# Example values for the Keycloak LDAP federation provider - this file does NOT
# configure federation automatically; use Keycloak UI or API to add LDAP provider.
freeipa:
  ldapUrl: "ldap://masternode.vmstation.local"
  bindDn: "uid=admin,cn=users,cn=accounts,dc=vmstation,dc=local"
  bindCredential: "CHANGEME_LDAP_BIND_PASSWORD"
  usersDn: "cn=users,cn=accounts,dc=vmstation,dc=local"
  searchScope: 1

# Additional flags
proxyAddressForwarding: true

# Resource requests/limits (tune for your environment)
resources:
  requests:
    cpu: "100m"
    memory: "256Mi"
  limits:
    cpu: "500m"
    memory: "1Gi"

# Health probes using Keycloak's dedicated endpoints
livenessProbe:
  httpGet:
    path: /health/live
    port: http
    scheme: HTTP
  initialDelaySeconds: 120  # Keycloak takes ~2 minutes to fully start
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 10
  successThreshold: 1

readinessProbe:
  httpGet:
    path: /health/ready
    port: http
    scheme: HTTP
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 2
  failureThreshold: 10
  successThreshold: 1

startupProbe:
  httpGet:
    path: /health/started  # KEY FIX: Use the startup health endpoint
    port: http
    scheme: HTTP
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 2
  failureThreshold: 90  # 90 * 10s = 15 minutes max startup time
  successThreshold: 1
