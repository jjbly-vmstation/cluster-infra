*** Begin Patch
*** Update File: ansible/roles/identity-keycloak/tasks/main.yml
@@
   register: keycloak_env_patch
   changed_when: "keycloak_env_patch.rc == 0"
+
+- name: Ensure keycloak-startup configmap has configured node identifier (remove stop-embedded-server)
+  shell: >-
+    cat <<'CM' | kubectl --kubeconfig=/etc/kubernetes/admin.conf apply -f -
+    apiVersion: v1
+    kind: ConfigMap
+    metadata:
+      name: keycloak-startup
+      namespace: {{ namespace_identity }}
+    data:
+      keycloak.cli: |
+        embed-server --server-config=standalone-ha.xml --std-out=echo
+        batch
+
+        echo Configuring node identifier
+
+        ## Sets the node identifier to the node name (= pod name). Node identifiers have to be unique. They can have a
+        ## maximum length of 23 characters. Thus, the chart's fullname template truncates its length accordingly.
+        /subsystem=transactions:write-attribute(name=node-identifier, value=${jboss.node.name})
+
+        echo Finished configuring node identifier
+
+        run-batch
+    CM
+  environment:
+    KUBECONFIG: /etc/kubernetes/admin.conf
+  become: true
+  register: keycloak_startup_cm
+  changed_when: "'configured' in keycloak_startup_cm.stdout or 'created' in keycloak_startup_cm.stdout"
+
+- name: Restart Keycloak pod to pick up new configmap
+  shell: >-
+    KUBECONFIG=/etc/kubernetes/admin.conf kubectl -n {{ namespace_identity }} delete pod keycloak-0 || true
+  environment:
+    KUBECONFIG: /etc/kubernetes/admin.conf
+  become: true
+  changed_when: false
*** End Patch
