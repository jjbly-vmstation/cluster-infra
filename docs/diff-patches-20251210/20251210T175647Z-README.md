# Identity Stack Fixes and Automation - Quick Reference
**Date:** 2025-12-10T17:56:47Z  
**Session:** Cert-Manager Pod Placement, Keycloak Desktop Access, Admin Automation

## Files in This Patch Set

### 1. 20251210T175647Z-cert-manager-nodeSelector-fix.patch
**Purpose:** Fix cert-manager pod placement to masternode only  
**Type:** Documentation + Manual Commands  
**Status:** Applied manually, automated in playbook

**Quick Apply:**
```bash
kubectl patch deployment cert-manager-cainjector -n cert-manager \
  -p '{"spec":{"template":{"spec":{"nodeSelector":{"kubernetes.io/hostname":"masternode"}}}}}'

kubectl patch deployment cert-manager-webhook -n cert-manager \
  -p '{"spec":{"template":{"spec":{"nodeSelector":{"kubernetes.io/hostname":"masternode"}}}}}'
```

### 2. 20251210T175647Z-keycloak-nodeport-service.yaml
**Purpose:** NodePort service for desktop access to Keycloak  
**Type:** Kubernetes manifest  
**Ports:** 30080 (HTTP), 30443 (HTTPS)

**Quick Apply:**
```bash
kubectl apply -f /opt/vmstation-org/diff-patches/20251210T175647Z-keycloak-nodeport-service.yaml
```

**Access:** `http://<any-node-ip>:30080/auth`

### 3. 20251210T175647Z-keycloak-admin-setup.sh
**Purpose:** Standalone script for Keycloak admin user creation  
**Type:** Bash script (executable)  
**Use Case:** Manual/emergency admin user setup

**Quick Run:**
```bash
sudo /opt/vmstation-org/diff-patches/20251210T175647Z-keycloak-admin-setup.sh
```

### 4. 20251210T175647Z-identity-playbook-automation.patch
**Purpose:** Git diff of all changes to identity-deploy-and-handover.yml  
**Type:** Unified diff patch (707 lines)  
**Status:** Already applied to playbook

**Changes Include:**
- Cert-manager nodeSelector patches (lines 816-831)
- Keycloak NodePort service deployment (lines 988-1023)
- Admin user creation automation (lines 1025-1103)
- Credential storage and display

**To Review:**
```bash
less /opt/vmstation-org/diff-patches/20251210T175647Z-identity-playbook-automation.patch
```

**To Revert (if needed):**
```bash
cd /opt/vmstation-org/cluster-infra
git checkout ansible/playbooks/identity-deploy-and-handover.yml
```

### 5. 20251210T175647Z-IDENTITY-AUTOMATION.md
**Purpose:** Comprehensive documentation of all changes  
**Type:** Markdown documentation (11KB)  
**Contents:**
- Detailed problem descriptions
- Solution implementations
- Verification procedures
- Security considerations
- Rollback procedures
- Testing checklist
- Troubleshooting guide

**Read:**
```bash
less /opt/vmstation-org/diff-patches/20251210T175647Z-IDENTITY-AUTOMATION.md
```

### 6. 20251210T175647Z-README.md (this file)
**Purpose:** Quick reference index for all patch files  
**Type:** Markdown index

---

## What Was Fixed

### ✅ Issue 1: Cert-Manager Pod Placement
**Before:**
```
cert-manager-cainjector → homelab node ❌
cert-manager-webhook    → homelab node ❌
cert-manager            → masternode ✅
```

**After:**
```
cert-manager-cainjector → masternode ✅
cert-manager-webhook    → masternode ✅
cert-manager            → masternode ✅
```

### ✅ Issue 2: Keycloak Desktop Access
**Before:** No external access configured ❌

**After:** 
- NodePort service on ports 30080/30443 ✅
- Accessible from any desktop: `http://<node-ip>:30080/auth` ✅

### ✅ Issue 3: Admin User Automation
**Before:** Manual admin user creation required ❌

**After:**
- Automatic admin user creation ✅
- Secure password generation ✅
- Credentials saved to `/root/identity-backup/` ✅
- Access info displayed after deployment ✅

---

## Quick Verification

### 1. Check Cert-Manager Pods
```bash
sudo kubectl get pods -n cert-manager -o wide
```
**Expected:** All pods on `masternode`

### 2. Check Keycloak Service
```bash
sudo kubectl get svc -n identity keycloak-nodeport
```
**Expected:** NodePort service with ports 30080:30080, 8443:30443

### 3. Test Desktop Access
```bash
curl -I http://192.168.4.63:30080/auth
```
**Expected:** HTTP/1.1 200 OK

### 4. View Admin Credentials
```bash
sudo cat /root/identity-backup/keycloak-admin-credentials.txt
```
**Expected:** Username, password, and access URLs

---

## Playbook Usage

### Run Complete Deployment (Automated)
```bash
cd /opt/vmstation-org/cluster-infra
ansible-playbook ansible/playbooks/identity-deploy-and-handover.yml
```

**New Automated Steps:**
1. ✅ Deploy cert-manager with masternode nodeSelector
2. ✅ Patch cainjector and webhook for masternode
3. ✅ Deploy Keycloak with NodePort service
4. ✅ Create admin user with secure password
5. ✅ Save credentials to `/root/identity-backup/`
6. ✅ Display access information

### Custom Admin Password (Optional)
```bash
ansible-playbook ansible/playbooks/identity-deploy-and-handover.yml \
  -e keycloak_admin_password="your-custom-password"
```

### Force Replace/Recovery Mode
```bash
ansible-playbook ansible/playbooks/identity-deploy-and-handover.yml \
  -e identity_force_replace=true
```

---

## Desktop Access URLs

After deployment, access Keycloak from any desktop on the network:

**Keycloak Welcome:**
- http://192.168.4.63:30080/auth (masternode)
- http://192.168.4.62:30080/auth (homelab)
- http://192.168.4.61:30080/auth (storagenodet3500)

**Admin Console:**
- http://192.168.4.63:30080/auth/admin
- http://192.168.4.62:30080/auth/admin
- http://192.168.4.61:30080/auth/admin

**Default Credentials:**
- Username: `admin`
- Password: Check `/root/identity-backup/keycloak-admin-credentials.txt`

---

## Integration with Monitoring Stack

These changes prepare the identity stack for integration with the monitoring stack:

### Keycloak Metrics
- **Endpoint:** `/auth/realms/master/metrics`
- **Port:** 8080 (via NodePort 30080)

### Prometheus ServiceMonitor (Future)
```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: keycloak
  namespace: identity
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: keycloak
  endpoints:
    - port: http
      path: /auth/realms/master/metrics
```

### Grafana Dashboard
- **Import:** Dashboard ID 10441 (Keycloak Metrics)
- **Datasource:** Prometheus from monitoring stack

---

## Security Notes

### Credential Storage
- Location: `/root/identity-backup/keycloak-admin-credentials.txt`
- Permissions: `0600` (root only)
- Contains: Username, password, access URLs

### Password Generation
- Method: `openssl rand -base64 32`
- Length: 32 characters base64-encoded
- Entropy: ~192 bits

### Network Exposure
- **Type:** NodePort (K8s standard)
- **Ports:** 30080 (HTTP), 30443 (HTTPS)
- **Scope:** All cluster node IPs
- **Recommendation:** Use ingress with TLS for production

---

## Troubleshooting

### Pods on Wrong Node
```bash
# Delete pods to trigger rescheduling
sudo kubectl delete pod -n cert-manager -l app=cainjector
sudo kubectl delete pod -n cert-manager -l app=webhook
```

### Cannot Access from Desktop
```bash
# Check service
sudo kubectl get svc -n identity keycloak-nodeport

# Check firewall (example - adjust for your firewall)
sudo firewall-cmd --list-all
sudo firewall-cmd --add-port=30080/tcp --permanent
sudo firewall-cmd --reload
```

### Admin Login Fails
```bash
# View credentials
sudo cat /root/identity-backup/keycloak-admin-credentials.txt

# Check Keycloak logs
sudo kubectl logs -n identity keycloak-0 --tail=50
```

### Playbook Fails
```bash
# Check diagnostics
ls -lh /root/identity-backup/*diagnostics*

# View latest diagnostics
sudo cat /root/identity-backup/*diagnostics*$(ls -t /root/identity-backup/*diagnostics* | head -1)
```

---

## Next Steps

1. ✅ **Verify Access:** Test login to Keycloak from desktop
2. ✅ **Change Password:** Update admin password via Keycloak UI
3. ⏳ **Deploy Ingress:** Install nginx-ingress or traefik for TLS
4. ⏳ **Configure TLS:** Use cert-manager + freeipa-ca-issuer
5. ⏳ **LDAP Integration:** Connect Keycloak to FreeIPA
6. ⏳ **Monitoring:** Deploy cluster-monitor-stack with Keycloak metrics

---

## Related Files

**Playbook:**
- `/opt/vmstation-org/cluster-infra/ansible/playbooks/identity-deploy-and-handover.yml`

**Helm Values:**
- `/opt/vmstation-org/cluster-infra/helm/keycloak-values.yaml`

**Credentials:**
- `/root/identity-backup/keycloak-admin-credentials.txt`

**Backups:**
- `/root/identity-backup/*.tar.gz`

**Diagnostics:**
- `/root/identity-backup/*diagnostics*.log`

---

## Contact and Support

**Documentation:** `/opt/vmstation-org/diff-patches/20251210T175647Z-IDENTITY-AUTOMATION.md`

**Verification Commands:**
```bash
# Full identity stack status
sudo kubectl get all -n identity -o wide

# Cert-manager status
sudo kubectl get all -n cert-manager -o wide

# ClusterIssuer status
sudo kubectl get clusterissuers

# Desktop access test
curl -I http://$(hostname -I | awk '{print $1}'):30080/auth
```

---

**Patch Set Version:** 1.0  
**Timestamp:** 2025-12-10T17:56:47Z  
**Status:** ✅ All changes implemented and documented
