apiVersion: batch/v1
kind: Job
metadata:
  name: freeipa-chown-job
  namespace: {{ namespace_identity }}
spec:
  backoffLimit: 0
  template:
    metadata:
      name: freeipa-chown
    spec:
      {% if infra_node is defined and infra_node != '' -%}
      nodeSelector:
        kubernetes.io/hostname: {{ infra_node }}
      {% endif -%}
      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
      restartPolicy: OnFailure
      containers:
        - name: chown
          image: busybox:1.36
          command: ["/bin/sh", "-c", "chown -R 0:0 {{ identity_data_dir }}/freeipa && ls -ld {{ identity_data_dir }}/freeipa && echo DONE"]
          securityContext:
            privileged: true
          volumeMounts:
            - name: host-freeipa
              mountPath: "{{ identity_data_dir }}/freeipa"
      volumes:
        - name: host-freeipa
          hostPath:
            path: "{{ identity_data_dir }}/freeipa"
            type: DirectoryOrCreate
