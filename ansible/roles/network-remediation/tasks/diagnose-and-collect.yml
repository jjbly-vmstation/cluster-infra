---
# Diagnostics collection and artifact archival
# Collects network state, logs, and configurations for troubleshooting

- name: Create diagnostics directory
  file:
    path: "{{ diagnostics_base_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Set diagnostics timestamp
  set_fact:
    diagnostics_timestamp: "{{ ansible_date_time.epoch }}"

- name: Collect cluster-wide diagnostics (from control plane)
  delegate_to: localhost
  become: false
  block:
    - name: Get CoreDNS deployment status
      shell: >-
        kubectl --kubeconfig={{ kubeconfig }} -n kube-system 
        get deployment coredns -o yaml
      register: coredns_deployment
      changed_when: false
      failed_when: false

    - name: Get CoreDNS pods
      shell: >-
        kubectl --kubeconfig={{ kubeconfig }} -n kube-system 
        get pods -l k8s-app=kube-dns -o wide
      register: coredns_pods
      changed_when: false
      failed_when: false

    - name: Get kube-dns Service details
      shell: >-
        kubectl --kubeconfig={{ kubeconfig }} -n kube-system 
        get svc kube-dns -o yaml
      register: kube_dns_service
      changed_when: false
      failed_when: false

    - name: Get kube-dns Endpoints
      shell: >-
        kubectl --kubeconfig={{ kubeconfig }} -n kube-system 
        get endpoints kube-dns -o yaml
      register: kube_dns_endpoints
      changed_when: false
      failed_when: false

    - name: Get kube-proxy DaemonSet
      shell: >-
        kubectl --kubeconfig={{ kubeconfig }} -n kube-system 
        get daemonset kube-proxy -o yaml
      register: kubeproxy_daemonset
      changed_when: false
      failed_when: false

    - name: Get kube-proxy pods
      shell: >-
        kubectl --kubeconfig={{ kubeconfig }} -n kube-system 
        get pods -l k8s-app=kube-proxy -o wide
      register: kubeproxy_pods
      changed_when: false
      failed_when: false

    - name: Get kube-proxy logs
      shell: >-
        kubectl --kubeconfig={{ kubeconfig }} -n kube-system 
        logs daemonset/kube-proxy --tail=500 --prefix=true
      register: kubeproxy_logs
      changed_when: false
      failed_when: false

    - name: Get CoreDNS logs
      shell: >-
        kubectl --kubeconfig={{ kubeconfig }} -n kube-system 
        logs deployment/coredns --tail=500 --prefix=true
      register: coredns_logs
      changed_when: false
      failed_when: false

    - name: Get all Services in kube-system
      shell: >-
        kubectl --kubeconfig={{ kubeconfig }} -n kube-system 
        get svc -o wide
      register: kube_system_services
      changed_when: false
      failed_when: false

    - name: Get kube-proxy ConfigMap
      shell: >-
        kubectl --kubeconfig={{ kubeconfig }} -n kube-system 
        get configmap kube-proxy -o yaml
      register: kubeproxy_configmap
      changed_when: false
      failed_when: false

    - name: Save cluster diagnostics
      copy:
        dest: "{{ diagnostics_base_dir }}/cluster-diagnostics-{{ diagnostics_timestamp }}.txt"
        content: |
          ============================================================
          Cluster Network Diagnostics
          Collected: {{ ansible_date_time.iso8601 }}
          ============================================================
          
          === CoreDNS Deployment ===
          {{ coredns_deployment.stdout | default('N/A') }}
          
          === CoreDNS Pods ===
          {{ coredns_pods.stdout | default('N/A') }}
          
          === kube-dns Service ===
          {{ kube_dns_service.stdout | default('N/A') }}
          
          === kube-dns Endpoints ===
          {{ kube_dns_endpoints.stdout | default('N/A') }}
          
          === kube-proxy DaemonSet ===
          {{ kubeproxy_daemonset.stdout | default('N/A') }}
          
          === kube-proxy Pods ===
          {{ kubeproxy_pods.stdout | default('N/A') }}
          
          === kube-proxy ConfigMap ===
          {{ kubeproxy_configmap.stdout | default('N/A') }}
          
          === kube-system Services ===
          {{ kube_system_services.stdout | default('N/A') }}
          
          === kube-proxy Logs (last 500 lines) ===
          {{ kubeproxy_logs.stdout | default('N/A') }}
          
          === CoreDNS Logs (last 500 lines) ===
          {{ coredns_logs.stdout | default('N/A') }}
        owner: root
        group: root
        mode: '0644'
      become: true

- name: Determine target nodes (exclude localhost)
  set_fact:
    target_nodes: "{{ groups['all'] | default([]) | difference(['localhost']) }}"

- name: Collect node-level diagnostics (from all nodes)
  when: target_nodes | length > 0
  include_tasks: collect-node-diagnostics.yml
  loop: "{{ target_nodes }}"
  loop_control:
    loop_var: node_target

- name: Create diagnostics archive
  delegate_to: localhost
  become: true
  block:
    - name: Ensure archive directory exists
      file:
        path: "{{ diagnostics_archive_dir }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Create tarball of diagnostics
      archive:
        path: "{{ diagnostics_base_dir }}/*"
        dest: "{{ diagnostics_archive_dir }}/network-diagnostics-{{ diagnostics_timestamp }}.tar.gz"
        format: gz
        owner: root
        group: root
        mode: '0644'

    - name: Display diagnostics location
      debug:
        msg:
          - "Network diagnostics collected successfully"
          - "Raw diagnostics: {{ diagnostics_base_dir }}"
          - "Archive: {{ diagnostics_archive_dir }}/network-diagnostics-{{ diagnostics_timestamp }}.tar.gz"

- name: Cleanup old diagnostics
  find:
    paths: "{{ diagnostics_base_dir }}"
    age: "{{ diagnostics_retention_days }}d"
    recurse: yes
  register: old_diagnostics
  become: true

- name: Remove old diagnostics files
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ old_diagnostics.files }}"
  when: old_diagnostics.files | length > 0
  become: true

- name: Diagnostics collection completed
  debug:
    msg: "âœ“ Network diagnostics collected and archived"
