---
# Remediation loop with retries
# Attempts validation -> remediation -> validation cycle up to max_attempts

- name: Network validation and remediation attempt {{ current_remediation_attempt | int + 1 }}/{{ remediation_max_attempts }}
  block:
    - name: Increment attempt counter
      set_fact:
        current_remediation_attempt: "{{ current_remediation_attempt | int + 1 }}"

    - name: Attempt DNS validation
      include_tasks: validate-pod-to-clusterip.yml
      
    - name: Mark validation as passed
      set_fact:
        validation_passed: true
        
  rescue:
    - name: DNS validation failed - starting remediation
      debug:
        msg: "DNS validation failed on attempt {{ current_remediation_attempt }}/{{ remediation_max_attempts }}"

    - name: Collect diagnostics before remediation
      include_tasks: diagnose-and-collect.yml
      when: diagnostics_enabled | bool

    - name: Mark diagnostics as collected
      set_fact:
        diagnostics_collected: true
      when: diagnostics_enabled | bool

    - name: Check if we should retry remediation
      assert:
        that:
          - (current_remediation_attempt | int) < (remediation_max_attempts | int)
        fail_msg: |
          Network remediation failed after {{ remediation_max_attempts }} attempts.
          
          DNS validation continues to fail despite:
          1. Fixing ip_forward
          2. Fixing iptables FORWARD chain
          3. Loading br_netfilter
          4. Restarting kube-proxy
          5. Clearing IPVS state (if applicable)
          
          Manual intervention required. Check diagnostics at:
          {{ diagnostics_base_dir }}
          
          Archived diagnostics: {{ diagnostics_archive_dir }}/network-diagnostics-{{ ansible_date_time.epoch }}.tar.gz

    - name: Run node-level network remediation
      include_tasks: remediate-node-network.yml

    - name: Wait before retry
      pause:
        seconds: "{{ remediation_retry_delay }}"
        prompt: "Waiting {{ remediation_retry_delay }} seconds before retry..."

    - name: Retry validation after remediation
      include_tasks: remediation-loop.yml
