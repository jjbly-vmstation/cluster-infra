---
# Node-level network remediation tasks
# Runs on all cluster nodes to fix common network/dataplane issues

- name: Start network remediation on all nodes
  debug:
    msg: "Running network remediation on all cluster nodes"

# This section runs on localhost (control plane) to gather cluster info
- name: Detect kube-proxy mode from ConfigMap
  delegate_to: localhost
  become: false
  block:
    - name: Read kube-proxy ConfigMap
      shell: >-
        kubectl --kubeconfig={{ kubeconfig }} -n kube-system
        get configmap kube-proxy -o jsonpath='{.data.config\.conf}'
      register: kubeproxy_config
      changed_when: false
      failed_when: false

    - name: Extract mode from config (with fallback)
      set_fact:
        detected_kubeproxy_mode: "{{ (kubeproxy_config.stdout | default('') | regex_search('mode:\\s*\"?([A-Za-z0-9_-]+)\"?', '\\1') | default(['iptables'], true))[0] }}"
      when: kubeproxy_config.rc == 0

    - name: Set default mode if detection failed
      set_fact:
        detected_kubeproxy_mode: 'iptables'
      when: kubeproxy_config.rc != 0 or detected_kubeproxy_mode is not defined

    - name: Display detected kube-proxy mode
      debug:
        msg: "Detected kube-proxy mode: {{ detected_kubeproxy_mode | default('iptables') }}"

- name: Determine target nodes (exclude localhost)
  set_fact:
    target_nodes: "{{ groups['all'] | default([]) | difference(['localhost']) }}"

- name: Run remediation tasks on all nodes
  include_tasks: remediate-node-network-per-node.yml
  loop: "{{ target_nodes }}"
  loop_control:
    loop_var: node_target
  when: target_nodes | length > 0

- name: Restart kube-proxy DaemonSet
  delegate_to: localhost
  become: false
  block:
    - name: Rollout restart kube-proxy
      shell: >-
        kubectl --kubeconfig={{ kubeconfig }} -n kube-system
        rollout restart daemonset/kube-proxy
      register: kubeproxy_restart
      changed_when: kubeproxy_restart.rc == 0
      when: remediation_restart_kube_proxy | bool

    - name: Wait for kube-proxy rollout to complete
      shell: >-
        kubectl --kubeconfig={{ kubeconfig }} -n kube-system
        rollout status daemonset/kube-proxy --timeout=180s
      register: kubeproxy_rollout_status
      changed_when: false
      failed_when: kubeproxy_rollout_status.rc != 0
      when: remediation_restart_kube_proxy | bool

    - name: Wait for kube-proxy pods to be ready
      pause:
        seconds: 15
        prompt: "Waiting for kube-proxy pods to stabilize..."
      when: remediation_restart_kube_proxy | bool

- name: Network remediation completed
  debug:
    msg: "âœ“ Node-level network remediation completed successfully"
