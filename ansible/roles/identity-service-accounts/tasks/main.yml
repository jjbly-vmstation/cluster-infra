---
# This role runs on the Ansible controller and uses kubectl exec into the
# FreeIPA pod to run `ipa` commands as the FreeIPA admin user. It expects
# the FreeIPA admin credentials to be stored in the Kubernetes secret
# `freeipa-admin-creds` in the `identity` namespace (created elsewhere).

- name: Read FreeIPA admin password from k8s secret
  kubernetes.core.k8s_info:
    kind: Secret
    namespace: identity
    name: freeipa-admin-creds
  register: freeipa_admin_secret
  failed_when: false

- name: Set FreeIPA admin password fact
  ansible.builtin.set_fact:
    freeipa_admin_password: "{{ (freeipa_admin_secret.resources[0].data.password | default('')) | b64decode | string }}"
  when: freeipa_admin_secret.resources is defined and freeipa_admin_secret.resources | length > 0

- name: Fail if FreeIPA admin password not found
  ansible.builtin.fail:
    msg: "FreeIPA admin password not found in secret freeipa-admin-creds"
  when: freeipa_admin_password | default('') == ''

- name: Get FreeIPA pod name
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: identity
    label_selectors:
      - app=freeipa
  register: freeipa_pods
  failed_when: false

- name: Set FreeIPA pod fact
  ansible.builtin.set_fact:
    freeipa_pod: "{{ (freeipa_pods.resources[0].metadata.name | default('')) }}"
  when: freeipa_pods.resources is defined and freeipa_pods.resources | length > 0

- name: Fail if FreeIPA pod not found
  ansible.builtin.fail:
    msg: "FreeIPA pod not found in namespace 'identity'"
  when: freeipa_pod | default('') == ''

- name: Check if FreeIPA PVC is bound
  kubernetes.core.k8s_info:
    kind: PersistentVolumeClaim
    namespace: identity
    name: freeipa-data
  register: freeipa_pvc_status
  failed_when: false

- name: Wait for FreeIPA PVC to bind (if Pending)
  kubernetes.core.k8s_info:
    kind: PersistentVolumeClaim
    namespace: identity
    name: freeipa-data
  register: freeipa_pvc_wait
  until: >
    freeipa_pvc_wait.resources is defined and
    freeipa_pvc_wait.resources | length > 0 and
    freeipa_pvc_wait.resources[0].status.phase | default('') == 'Bound'
  retries: 30
  delay: 5
  when: >
    freeipa_pvc_status.resources is defined and
    freeipa_pvc_status.resources | length > 0 and
    freeipa_pvc_status.resources[0].status.phase | default('') == 'Pending'

- name: Check if FreeIPA pod is ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: identity
    name: "{{ freeipa_pod }}"
  register: freeipa_pod_status
  failed_when: false

- name: Display FreeIPA pod current state
  ansible.builtin.debug:
    msg: |
      FreeIPA pod '{{ freeipa_pod }}' status:
      - Phase: {{ freeipa_pod_status.resources[0].status.phase | default('Unknown') }}
      - Container Ready: {{ (freeipa_pod_status.resources[0].status.containerStatuses | selectattr('name', 'equalto', 'freeipa-server') | map(attribute='ready') | first | default(false)) }}
      - Restart Count: {{ (freeipa_pod_status.resources[0].status.containerStatuses | selectattr('name', 'equalto', 'freeipa-server') | map(attribute='restartCount') | first | default(0)) }}
  when: freeipa_pod_status.resources is defined and freeipa_pod_status.resources | length > 0

- name: Fail if FreeIPA pod is in Failed state (actual crash)
  ansible.builtin.fail:
    msg: |
      FreeIPA pod '{{ freeipa_pod }}' is in Failed state.
      Check logs: kubectl -n identity logs {{ freeipa_pod }} -c freeipa-server --tail=200
      Check events: kubectl -n identity describe pod {{ freeipa_pod }}
  when: >
    freeipa_pod_status.resources is defined and
    freeipa_pod_status.resources | length > 0 and
    freeipa_pod_status.resources[0].status.phase | default('') == 'Failed'

- name: Get FreeIPA pod events if Pending
  ansible.builtin.shell: kubectl -n identity describe pod {{ freeipa_pod }} | tail -20
  register: freeipa_pending_events
  failed_when: false
  changed_when: false
  when: >
    freeipa_pod_status.resources is defined and
    freeipa_pod_status.resources | length > 0 and
    freeipa_pod_status.resources[0].status.phase | default('') == 'Pending'

- name: Fail fast if FreeIPA pod is stuck in Pending state
  ansible.builtin.fail:
    msg: |
      FreeIPA pod '{{ freeipa_pod }}' is stuck in Pending state.
      
      This means the pod cannot be scheduled. Common causes:
      1. Node affinity mismatch - no node matches the selector
      2. Insufficient resources on target node
      3. PVC binding issue (should have been caught earlier)
      4. Image pull issues
      
      Recent pod events:
      {{ freeipa_pending_events.stdout | default('Unable to retrieve events') }}
      
      Manual checks:
      kubectl -n identity describe pod {{ freeipa_pod }}
      kubectl -n identity get pvc freeipa-data
      kubectl get nodes --show-labels
  when: >
    freeipa_pod_status.resources is defined and
    freeipa_pod_status.resources | length > 0 and
    freeipa_pod_status.resources[0].status.phase | default('') == 'Pending'

- name: Wait for FreeIPA pod to be ready (only if not Pending or Failed)
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: identity
    name: "{{ freeipa_pod }}"
  register: freeipa_pod_ready
  until: >
    freeipa_pod_ready.resources is defined and
    freeipa_pod_ready.resources | length > 0 and
    freeipa_pod_ready.resources[0].status.phase == 'Running' and
    freeipa_pod_ready.resources[0].status.containerStatuses is defined and
    freeipa_pod_ready.resources[0].status.containerStatuses | selectattr('name', 'equalto', 'freeipa-server') | map(attribute='ready') | first | default(false)
  retries: 60
  delay: 10
  failed_when: false
  when: >
    freeipa_pod_status.resources is defined and
    freeipa_pod_status.resources | length > 0 and
    freeipa_pod_status.resources[0].status.phase | default('') not in ['Pending', 'Failed']

- name: Fail if FreeIPA pod did not become ready
  ansible.builtin.fail:
    msg: |
      FreeIPA pod '{{ freeipa_pod }}' did not become ready within 10 minutes.
      Final phase: {{ freeipa_pod_ready.resources[0].status.phase | default('Unknown') }}
      Run diagnostics: sudo /opt/vmstation-org/cluster-infra/scripts/diagnose-freeipa-failure.sh
  when: >
    freeipa_pod_ready.resources is not defined or
    freeipa_pod_ready.resources | length == 0 or
    freeipa_pod_ready.resources[0].status.phase != 'Running' or
    not (freeipa_pod_ready.resources[0].status.containerStatuses | selectattr('name', 'equalto', 'freeipa-server') | map(attribute='ready') | first | default(false))

- name: Ensure groups exist in FreeIPA
  ansible.builtin.shell: >-
    POD={{ freeipa_pod }};
    PASS='{{ freeipa_admin_password }}';
    for G in {{ service_groups | join(' ') }}; do
      kubectl -n identity exec "$POD" -c freeipa-server -- bash -lc "echo \"$PASS\" | kinit admin >/dev/null 2>&1 && ipa group-show $G >/dev/null 2>&1 && exit 0 || ipa group-add $G"
      rc=$?
      if [ $rc -ne 0 ]; then
        echo "Failed to create or verify group $G" >&2
        exit $rc
      fi
    done
  args:
    executable: /bin/bash

- name: Ensure service accounts exist in FreeIPA
  ansible.builtin.shell: |
    POD={{ freeipa_pod }}
    PASS='{{ freeipa_admin_password }}'
    NAME='{{ acct.name }}'
    FIRST='{{ acct.first }}'
    LAST='{{ acct.last }}'
    kubectl -n identity exec "$POD" -c freeipa-server -- bash -lc "echo \"$PASS\" | kinit admin >/dev/null 2>&1 && ipa user-show $NAME >/dev/null 2>&1 && exit 0 || ipa user-add $NAME --first=\"$FIRST\" --last=\"$LAST\""
    rc=$?
    if [ $rc -ne 0 ]; then
      echo "Failed to create or verify user $NAME" >&2
      exit $rc
    fi
  args:
    executable: /bin/bash
  loop: "{{ service_accounts }}"
  loop_control:
    loop_var: acct

- name: Set passwords for accounts when provided
  when: set_passwords | default(true)
  ansible.builtin.shell: >-
    POD={{ freeipa_pod }};
    PASS='{{ freeipa_admin_password }}';
    NAME='{{ acct.name }}';
    PWD='{{ acct.password | default("") }}';
    if [[ -n "$PWD" ]]; then
      kubectl -n identity exec "$POD" -c freeipa-server -- bash -lc "echo \"$PASS\" | kinit admin >/dev/null 2>&1 && echo -e \"$PWD\\n$PWD\" | ipa passwd $NAME"
      rc=$?
      if [ $rc -ne 0 ]; then
        echo "Failed to set password for user $NAME" >&2
        exit $rc
      fi
    fi
  args:
    executable: /bin/bash
  loop: "{{ service_accounts }}"
  loop_control:
    loop_var: acct
