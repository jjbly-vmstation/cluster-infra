---
- name: Request Keycloak admin access token
  uri:
    url: "{{ keycloak_admin_base_url }}/realms/{{ keycloak_admin_realm }}/protocol/openid-connect/token"
    method: POST
    headers:
      Content-Type: application/x-www-form-urlencoded
    body_format: form-urlencoded
    body:
      grant_type: password
      client_id: "{{ keycloak_admin_client_id }}"
      username: "{{ keycloak_admin_username }}"
      password: "{{ keycloak_admin_password_effective }}"
    return_content: true
    status_code: 200
    timeout: 60
  register: keycloak_token
  retries: 10
  delay: 10
  until: >
    keycloak_token is not failed and
    keycloak_token.json is defined and
    (keycloak_token.json.access_token | default('') | trim) != ''
  failed_when: false

- name: Fail if Keycloak token request failed after all retries
  fail:
    msg: |
      Failed to obtain Keycloak admin access token after {{ keycloak_token.attempts }} attempts.
      Last error: {{ keycloak_token.msg | default('Unknown error') }}
      URL: {{ keycloak_admin_base_url }}/realms/{{ keycloak_admin_realm }}/protocol/openid-connect/token
      
      This typically means:
      1. Keycloak is not fully started (wait longer after pod restart)
      2. Keycloak admin credentials are incorrect
      3. Network connectivity issues to Keycloak NodePort
      
      Check Keycloak pod status: kubectl -n identity get pods -l app.kubernetes.io/name=keycloak
      Check Keycloak logs: kubectl -n identity logs -l app.kubernetes.io/name=keycloak --tail=100
  when: >
    keycloak_token is failed or
    keycloak_token.json is not defined or
    (keycloak_token.json.access_token | default('') | trim) == ''

- name: Set Keycloak bearer token
  set_fact:
    keycloak_bearer_token: "{{ keycloak_token.json.access_token }}"
