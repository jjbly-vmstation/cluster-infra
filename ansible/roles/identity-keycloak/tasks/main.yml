---
# Tasks for identity-keycloak role
# Deploys and manages Keycloak via Helm

- name: Check if Keycloak values file exists
  stat:
    path: "{{ keycloak_values_file }}"
  register: keycloak_values_stat

- name: Install/upgrade Keycloak via Helm (PostgreSQL disabled)
  shell: >-
    helm repo add codecentric https://codecentric.github.io/helm-charts >/dev/null 2>&1 || true;
    helm repo update >/dev/null 2>&1;
    helm upgrade --install keycloak {{ keycloak_helm_chart }} 
    -n {{ namespace_identity }} 
    -f {{ keycloak_values_file }} 
    --create-namespace 
    --set postgresql.enabled=false
  when: keycloak_values_stat.stat.exists
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: keycloak_helm_install
  become: true

- name: Wait for Keycloak StatefulSet rollout
  shell: >-
    KUBECONFIG=/etc/kubernetes/admin.conf kubectl rollout status statefulset/keycloak 
    -n {{ namespace_identity }} --timeout={{ rollout_wait_timeout }}s
  register: keycloak_rollout
  failed_when: keycloak_rollout.rc != 0
  become: true

- name: Deploy Keycloak NodePort Service for desktop access
  shell: >-
    cat <<EOF | kubectl apply -f -
    apiVersion: v1
    kind: Service
    metadata:
      name: keycloak-nodeport
      namespace: {{ namespace_identity }}
      labels:
        app: keycloak
        component: nodeport
      annotations:
        description: "NodePort service for desktop access to Keycloak"
    spec:
      type: NodePort
      ports:
        - name: http
          port: 80
          targetPort: 8080
          nodePort: 30080
          protocol: TCP
        - name: https
          port: 8443
          targetPort: 8443
          nodePort: 30443
          protocol: TCP
      selector:
        app.kubernetes.io/name: keycloak
    EOF
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: keycloak_nodeport_apply
  changed_when: "'created' in keycloak_nodeport_apply.stdout or 'configured' in keycloak_nodeport_apply.stdout"
  become: true
