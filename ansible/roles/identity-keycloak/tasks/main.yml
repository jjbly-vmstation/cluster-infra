---
# Tasks for identity-keycloak role
# Deploys and manages Keycloak via Helm

- name: Check if Keycloak values file exists
  stat:
    path: "{{ keycloak_values_file }}"
  register: keycloak_values_stat

- name: Generate Keycloak admin password when not provided
  shell: openssl rand -base64 32
  register: keycloak_admin_password_gen
  become: false
  when: keycloak_admin_password is not defined or keycloak_admin_password == ''

- name: Ensure Keycloak admin password fact is set
  set_fact:
    keycloak_admin_password: >-
      {{ keycloak_admin_password
         if (keycloak_admin_password is defined and keycloak_admin_password != '')
         else (keycloak_admin_password_gen.stdout | default('') | trim) }}

- name: Ensure backup directory exists for credentials
  file:
    path: "{{ backup_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0700'
  become: true

- name: Generate PostgreSQL password
  shell: openssl rand -base64 32
  register: postgresql_password_gen
  become: false

- name: Set PostgreSQL password fact
  set_fact:
    postgresql_password: "{{ postgresql_password_gen.stdout | trim }}"

- name: Install/upgrade Keycloak via Helm (PostgreSQL disabled)
  shell: >-
    helm repo add codecentric https://codecentric.github.io/helm-charts >/dev/null 2>&1 || true;
    helm repo update >/dev/null 2>&1;
    helm upgrade --install keycloak {{ keycloak_helm_chart }} 
    -n {{ namespace_identity }} 
    -f {{ keycloak_values_file }} 
    --set-string secrets.admin.stringData.KEYCLOAK_USER="admin"
    --set-string secrets.admin.stringData.KEYCLOAK_PASSWORD="{{ keycloak_admin_password }}"
    --create-namespace 
    --set postgresql.enabled=false
  when: keycloak_values_stat.stat.exists
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: keycloak_helm_install
  become: true

- name: Patch Keycloak StatefulSet to schedule on control-plane node
  shell: >-
    KUBECONFIG=/etc/kubernetes/admin.conf kubectl patch statefulset keycloak -n {{ namespace_identity }} --type='json' -p='[
      {"op": "add", "path": "/spec/template/spec/nodeSelector", "value": {"node-role.kubernetes.io/control-plane": ""}},
      {"op": "add", "path": "/spec/template/spec/tolerations", "value": [{"key": "node-role.kubernetes.io/control-plane", "operator": "Exists", "effect": "NoSchedule"}]}
    ]'
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  become: true
  when: keycloak_values_stat.stat.exists

- name: Restart Keycloak StatefulSet to apply nodeSelector changes
  shell: >-
    KUBECONFIG=/etc/kubernetes/admin.conf kubectl rollout restart statefulset/keycloak -n {{ namespace_identity }}
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  become: true
  when: keycloak_values_stat.stat.exists

- name: Wait for Keycloak pod(s) to be ready (by pod condition)
  shell: >-
    KUBECONFIG=/etc/kubernetes/admin.conf kubectl wait --for=condition=ready pod
    -l app.kubernetes.io/instance=keycloak -n {{ namespace_identity }} --timeout={{ pod_wait_timeout }}s
  register: keycloak_pod_wait
  failed_when: keycloak_pod_wait.rc != 0
  become: true

- name: Wait for Keycloak admin API to respond
  shell: >-
    KUBECONFIG=/etc/kubernetes/admin.conf kubectl -n {{ namespace_identity }} exec keycloak-0 -- sh -lc '
    for i in $(seq 1 60); do
      if curl -sSf http://localhost:8080/realms/master >/dev/null 2>&1 || curl -sSf http://localhost:8080/auth/realms/master >/dev/null 2>&1; then
        exit 0
      fi
      sleep 5
    done
    exit 1'
  register: keycloak_admin_ready
  failed_when: keycloak_admin_ready.rc != 0
  become: true
  retries: 1
  delay: 1

- name: Read Keycloak admin password from chart-managed secret
  shell: >-
    KUBECONFIG=/etc/kubernetes/admin.conf kubectl get secret keycloak-admin -n {{ namespace_identity }}
    -o jsonpath='{.data.KEYCLOAK_PASSWORD}' | base64 -d
  register: keycloak_admin_password_from_secret
  changed_when: false
  failed_when: false
  become: true

- name: Set effective Keycloak admin password fact
  set_fact:
    keycloak_admin_password_effective: >-
      {{ (keycloak_admin_password_from_secret.stdout | default('') | trim)
         if (keycloak_admin_password_from_secret is defined and (keycloak_admin_password_from_secret.stdout | default('') | trim) != '')
         else keycloak_admin_password }}

- name: Save Keycloak admin credentials to backup directory (from cluster source-of-truth)
  copy:
    content: |
      ============================================================
      Keycloak Administrator Credentials
      ============================================================
      Generated: {{ ansible_date_time.iso8601 }}

      URL: http://<masternode-ip>:30180/auth
      Username: admin
      Password: {{ keycloak_admin_password_effective }}

      SECURITY NOTICE:
      - This file contains sensitive credentials
      - Keep it secure and backed up
      - Change default passwords immediately in production
      - This password is SEPARATE from FreeIPA admin password

      Note: FreeIPA admin password is set separately via
      CHANGEME_IPA_ADMIN_PASSWORD in playbook variables
      ============================================================
    dest: "{{ backup_dir }}/keycloak-admin-credentials.txt"
    owner: root
    group: root
    mode: '0600'
  become: true

# Fallback rollout status for visibility only - failures are intentionally ignored
# Uses shorter timeout (rollout_wait_timeout) since this is supplementary to the robust pod wait above
- name: Fallback - Show rollout status for visibility
  shell: >-
    KUBECONFIG=/etc/kubernetes/admin.conf kubectl rollout status statefulset/keycloak -n {{ namespace_identity }} --timeout={{ rollout_wait_timeout }}s || true
  register: keycloak_rollout_fallback
  changed_when: false
  become: true

- name: Deploy Keycloak NodePort Service for desktop access
  shell: |
    cat <<EOF | kubectl apply -f -
    apiVersion: v1
    kind: Service
    metadata:
      name: keycloak-nodeport
      namespace: {{ namespace_identity }}
      labels:
        app: keycloak
        component: nodeport
      annotations:
        description: "NodePort service for desktop access to Keycloak"
    spec:
      type: NodePort
      ports:
        - name: http
          port: 80
          targetPort: 8080
          nodePort: {{ keycloak_nodeport_http }}
          protocol: TCP
        - name: https
          port: 8443
          targetPort: 8443
          nodePort: {{ keycloak_nodeport_https }}
          protocol: TCP
      selector:
        app.kubernetes.io/name: keycloak
    EOF
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: keycloak_nodeport_apply
  changed_when: "'created' in keycloak_nodeport_apply.stdout or 'configured' in keycloak_nodeport_apply.stdout"
  become: true

- name: Restart Keycloak StatefulSet to pick up new configmap
  shell: >-
    KUBECONFIG=/etc/kubernetes/admin.conf kubectl -n {{ namespace_identity }} rollout restart statefulset/keycloak
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  become: true
  register: keycloak_restart
  changed_when: keycloak_restart.rc == 0
  failed_when: false

- name: Wait for Keycloak pod to be ready after restart
  shell: >-
    KUBECONFIG=/etc/kubernetes/admin.conf kubectl wait --for=condition=ready pod/keycloak-0 
    -n {{ namespace_identity }} --timeout=300s
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  become: true
  register: keycloak_pod_ready
  failed_when: false

- name: Create monitoring namespace for SSO client secrets
  shell: >-
    KUBECONFIG=/etc/kubernetes/admin.conf kubectl create namespace {{ namespace_monitoring }} --dry-run=client -o yaml | kubectl apply -f -
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  become: true
  changed_when: false


