---
# tasks file for identity-bootstrap
- name: Ensure cert cache directory exists on target
  file:
    path: "{{ cert_cache_path | default('/var/cache/cluster-cert-bootstrap') }}"
    state: directory
    mode: '0755'

- name: Check for pre-generated certs on control path
  stat:
    path: "{{ cert_source_path | default('/opt/vmstation-org/cluster-setup/scripts/certs') }}"
  register: certs_stat

- name: Copy certs from control host to target (if present)
  when: certs_stat.stat.exists
  synchronize:
    src: "{{ cert_source_path }}"
    dest: "{{ cert_cache_path | default('/var/cache/cluster-cert-bootstrap') }}"
    mode: pull
  delegate_to: localhost

- name: Placeholder - install FreeIPA
  debug:
    msg: "Install/configure FreeIPA here (role not implemented). After install, import CA cert from {{ cert_cache_path }}"

- name: Placeholder - install Keycloak (SAML)
  debug:
    msg: "Install/configure Keycloak here (role not implemented). Configure TLS and SAML providers as required."

- name: Placeholder - configure cert-manager issuer pointing to FreeIPA CA
  debug:
    msg: "Create cert-manager Issuer/ClusterIssuer to point to the FreeIPA CA (not implemented)."
