---
# Role: freeipa
# Purpose: create CA secret in-cluster and a cert-manager ClusterIssuer that uses it.
 - name: Ensure namespace for identity exists
  k8s:
     state: present
     definition:
       apiVersion: v1
       kind: Namespace
       metadata:
         name: identity

 - name: Read CA cert file from control host
  slurp:
     src: "{{ cert_source_path | default('/opt/vmstation-org/cluster-setup/scripts/certs/ca.cert.pem') }}"
   register: ca_cert_b64

 - name: Read CA key file from control host
  slurp:
     src: "{{ cert_source_key | default('/opt/vmstation-org/cluster-setup/scripts/certs/ca.key.pem') }}"
   register: ca_key_b64

 - name: Create or update Kubernetes secret with CA (for cert-manager)
  k8s:
     state: present
     definition:
       apiVersion: v1
       kind: Secret
       metadata:
         name: freeipa-ca
         namespace: cert-manager
       type: kubernetes.io/tls
       data:
         tls.crt: "{{ ca_cert_b64.content }}"
         tls.key: "{{ ca_key_b64.content }}"

 - name: Render ClusterIssuer manifest for cert-manager (FreeIPA CA)
  template:
     src: clusterissuer-freeipa.yml.j2
     dest: "/tmp/clusterissuer-freeipa.yml"

 - name: Apply ClusterIssuer manifest
  k8s:
     state: present
     src: /tmp/clusterissuer-freeipa.yml

 - name: Info - FreeIPA role complete
  debug:
    msg: "FreeIPA role created secret freeipa-ca in namespace cert-manager and applied a ClusterIssuer."

 - name: Optionally install FreeIPA via Helm (if variables provided)
  when: freeipa_install_enabled | default(false) | bool
  block:
    - name: Add FreeIPA helm repo if provided
      community.kubernetes.helm_repository:
        name: "{{ freeipa_helm_repo_name }}"
        repo_url: "{{ freeipa_helm_repo }}"

    - name: Ensure FreeIPA namespace exists
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ freeipa_namespace | default('freeipa') }}"

    - name: Install/Upgrade FreeIPA Helm chart
      community.kubernetes.helm:
        name: "{{ freeipa_release_name | default('freeipa') }}"
        chart_ref: "{{ freeipa_chart_name }}"
        release_namespace: "{{ freeipa_namespace | default('freeipa') }}"
        create_namespace: false
        values: "{{ freeipa_values | default({}) }}"
        state: present

    - name: Debug FreeIPA info
      debug:
        msg: "FreeIPA helm release applied (release={{ freeipa_release_name | default('freeipa') }})."
