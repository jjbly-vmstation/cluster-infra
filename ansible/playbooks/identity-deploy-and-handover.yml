---
- name: Identity stack deploy and handover
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    # Repository root path (auto-detect from playbook location)
    repo_root: "{{ playbook_dir | dirname | dirname }}"
    # Control behavior
    identity_force_replace: false
    identity_backup_before_replace: true
    # FreeIPA network configuration
    identity_open_firewall: false
    # FreeIPA can take a long time to initialize on first run;
    # use a generous default timeout for pod readiness checks.
    freeipa_ready_timeout: 1200s
    # Role variable pass-through (roles will use their defaults if not specified)
    # Provide canonical namespace and data-dir defaults so roles have values
    namespace_identity: identity
    namespace_cert_manager: cert-manager
    namespace_platform: platform
    identity_data_dir: /srv/monitoring-data
    # Set all identity/admin passwords to a simple placeholder for testing
    keycloak_admin_password: "secret"
    # FreeIPA requires passwords >= 8 characters for ipa-server-install; use an 8+ test value
    freeipa_admin_password: "secret123"
    postgres_password: "secret"
    ca_key_password: "secret"
    ldap_bind_password: "secret"
    # enable_postgres_chown and enable_freeipa_chown default to role defaults

  tasks:
    # Phase 1: Prerequisites
    - name: Run identity prerequisites
      include_role:
        name: identity-prerequisites
      tags: [prerequisites, always]
    
    # Phase 2: Optional backup before destructive replace
    - name: Backup existing identity data before replace
      include_role:
        name: identity-backup
      when: identity_force_replace | default(false) | bool and identity_backup_before_replace | default(true) | bool
      tags: [backup]
    
    # Phase 3: Storage setup
    - name: Setup identity storage
      include_role:
        name: identity-storage
      tags: [storage]
    
    # Phase 4: Deploy PostgreSQL
    - name: Deploy PostgreSQL for Keycloak
      include_role:
        name: identity-postgresql
      tags: [postgresql, database]
    
    # Phase 5: Deploy Keycloak
    - name: Deploy Keycloak via Helm
      include_role:
        name: identity-keycloak
      tags: [keycloak]
    
    - name: Display Keycloak admin credentials
      debug:
        msg: |
          ============================================================
          Keycloak Admin Credentials
          ============================================================
          URL: http://<masternode-ip>:30180/auth
          Username: admin
          Password: {{ keycloak_admin_password | default('admin123') }}
          ============================================================
      tags: [keycloak]
    
    # Phase 6: Deploy FreeIPA (optional)
    - name: Deploy FreeIPA
      include_role:
        name: identity-freeipa
      tags: [freeipa]
    
    # Phase 6a: Ensure FreeIPA is reachable from cluster nodes
    # This phase patches the FreeIPA StatefulSet to enable hostNetwork
    # so that FreeIPA listens on node IPs, making it reachable for ipa-client-install
    - name: Ensure FreeIPA hostNetwork configuration
      include_tasks: tasks/ensure-freeipa-hostnetwork.yml
      tags: [freeipa, freeipa-network]

    # Phase 6b: Open firewall ports if connectivity check fails (opt-in)
    # This phase only runs if FreeIPA is not reachable after hostNetwork
    # and identity_open_firewall is set to true
    - name: Ensure FreeIPA firewall configuration (if needed)
      include_tasks: tasks/ensure-freeipa-firewall.yml
      when:
        - not (freeipa_reachable | default(true) | bool)
        - identity_open_firewall | default(false) | bool
      tags: [freeipa, freeipa-firewall]

    # Phase 6c: Fail with helpful message if FreeIPA still not reachable
    - name: Check final FreeIPA reachability status
      fail:
        msg: |
          ============================================================
          FreeIPA is NOT reachable from the Ansible controller!
          ============================================================
          
          FreeIPA needs to be accessible on the node IP for 
          ipa-client-install to work during node enrollment.
          
          Current Status:
            - hostNetwork: enabled
            - Firewall automation: {{ 'attempted' if identity_open_firewall | default(false) | bool else 'disabled' }}
            - Reachability: FAILED
          
          Troubleshooting Steps:
          
          1. Enable firewall automation (if not already enabled):
             ansible-playbook {{ playbook_dir }}/identity-deploy-and-handover.yml -e identity_open_firewall=true
          
          2. Manually open firewall ports on the infra node:
              On RHEL/Alma/CentOS:
               firewall-cmd --permanent --add-port={80,443,389,636,88,464}/tcp
               firewall-cmd --permanent --add-port={88,464}/udp
               firewall-cmd --reload
             
             On Debian/Ubuntu:
               ufw allow 80,443,389,636,88,464/tcp
               ufw allow 88,464/udp
          
          3. Use socat as a manual fallback to forward ports:
             socat TCP-LISTEN:389,fork TCP:{{ freeipa_pod_ip.stdout | default('<freeipa-pod-ip>') }}:389
          
          4. Verify connectivity manually:
             nc -vz {{ freeipa_host_ip.stdout | default('<node-ip>') }} 389
          
          For more information, see: docs/NOTE_FREEIPA_NETWORKING.md
          ============================================================
      when:
        - freeipa_reachable is defined
        - not (freeipa_reachable | bool)
        - identity_open_firewall | default(false) | bool
      tags: [freeipa, freeipa-network]

    - name: Display FreeIPA network configuration success
      debug:
        msg: |
          ============================================================
          FreeIPA Network Configuration: SUCCESS
          ============================================================
          FreeIPA is now reachable on node IP: {{ freeipa_host_ip.stdout | default('N/A') }}
          hostNetwork: enabled
          All required ports are accessible
          Node enrollment can proceed automatically
          ============================================================
      when:
        - freeipa_reachable is defined
        - freeipa_reachable | bool
      tags: [freeipa, freeipa-network]
    
    # Phase 7: Setup cert-manager and ClusterIssuer
    - name: Setup cert-manager and CA issuer
      include_role:
        name: identity-certmanager
      tags: [certmanager, ca]
    
    # Phase 8: Create administrator account
    - name: Create cluster administrator account
      include_role:
        name: identity-admin
      tags: [admin, credentials]
    
    # Phase 9: Final summary
    - name: Display deployment summary
      debug:
        msg: |
          ============================================================
          Identity Deployment Complete!
          ============================================================
          Infra Node: {{ infra_node }}
          
          Components Deployed:
            - PostgreSQL: Running
            - Keycloak: Running
            - FreeIPA: {{ 'Deployed' if freeipa_manifest_stat is defined and freeipa_manifest_stat.stat.exists else 'Skipped' }}
            - cert-manager: Installed
            - ClusterIssuer: Created
            - TLS Certificates: Deployed for Keycloak, Grafana, Prometheus
            - SSO Configuration: Prepared (requires manual completion)
          
          Access Keycloak:
            Run: kubectl get nodes -o wide
            Then access: http://<node-ip>:30180/auth
          
          Backup Location: /root/identity-backup
          Credentials: /root/identity-backup/cluster-admin-credentials.txt
          SSO Realm Config: /tmp/cluster-realm.json
          
          Next Steps for SSO:
            1. Access Keycloak admin console
            2. Import realm from /tmp/cluster-realm.json
            3. Configure LDAP user federation with FreeIPA
            4. Create OIDC client secrets for Grafana/Prometheus
            5. Deploy FreeIPA LDAP clients to cluster nodes (see playbook comments)
          
          To re-run with destructive replace:
            ansible-playbook {{ playbook_dir }}/identity-deploy-and-handover.yml -e identity_force_replace=true
          ============================================================
      tags: [always]

# Phase 10: Configure FreeIPA LDAP clients on all cluster nodes
# Note: This phase is commented out by default as it requires:
# 1. A running FreeIPA server (deployed in Phase 6)
# 2. Proper network connectivity to FreeIPA from all nodes
# 3. FreeIPA admin credentials
# Uncomment and configure when ready to enable cluster-wide LDAP authentication
#
# - name: Configure FreeIPA LDAP clients on all nodes
#   hosts: all  # Requires inventory with masternode, storagenodet3500, homelab
#   become: true
#   gather_facts: true
#   vars:
#     freeipa_server_hostname: "ipa.vmstation.local"
#     freeipa_domain: "vmstation.local"
#     freeipa_realm: "VMSTATION.LOCAL"
#     freeipa_server_ip: "192.168.4.63"
#     freeipa_admin_password: "{{ lookup('env', 'FREEIPA_ADMIN_PASSWORD') | default('CHANGEME_IPA_ADMIN_PASSWORD') }}"
#   roles:
#     - identity-freeipa-ldap-client
#   tags: [freeipa-client, ldap]
