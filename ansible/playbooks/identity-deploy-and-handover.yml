---
# Playbook: identity-deploy-and-handover.yml (Refactored)
# Purpose: Deploy FreeIPA, Keycloak, PostgreSQL, cert-manager with modular roles
# This playbook has been refactored to use roles for better modularity and maintainability.
#
# The control-plane taint issue has been resolved by ensuring all StatefulSets
# have appropriate tolerations for node-role.kubernetes.io/control-plane:NoSchedule.
#
# Enhanced with SSO capabilities: FreeIPA LDAP client integration and Keycloak SSO configuration

- name: Deploy identity stack and hand over CA to cert-manager
  hosts: localhost
  connection: local
  gather_facts: true
  
  vars:
    # Repository root path (auto-detect from playbook location)
    repo_root: "{{ playbook_dir | dirname | dirname }}"
    
    # Control behavior
    identity_force_replace: false
    identity_backup_before_replace: true
    
    # FreeIPA networking and firewall automation
    # Set to true to automatically open firewall ports if FreeIPA is not reachable
    identity_open_firewall: false
    
    # Role variable pass-through (roles will use their defaults if not specified)
    # Provide canonical namespace and data-dir defaults so roles have values
    namespace_identity: identity
    namespace_cert_manager: cert-manager
    namespace_platform: platform
    identity_data_dir: /srv/monitoring_data
    # enable_postgres_chown and enable_freeipa_chown default to role defaults
    
  tasks:
    # Phase 1: Prerequisites
    - name: Run identity prerequisites
      include_role:
        name: identity-prerequisites
      tags: [prerequisites, always]
    
    # Phase 2: Optional backup before destructive replace
    - name: Backup existing identity data before replace
      include_role:
        name: identity-backup
      when: identity_force_replace | default(false) | bool and identity_backup_before_replace | default(true) | bool
      tags: [backup]
    
    # Phase 3: Storage setup
    - name: Setup identity storage
      include_role:
        name: identity-storage
      tags: [storage]
    
    # Phase 4: Deploy PostgreSQL
    - name: Deploy PostgreSQL for Keycloak
      include_role:
        name: identity-postgresql
      tags: [postgresql, database]
    
    # Phase 5: Deploy Keycloak
    - name: Deploy Keycloak via Helm
      include_role:
        name: identity-keycloak
      tags: [keycloak]
    
    - name: Display Keycloak admin credentials
      debug:
        msg: |
          ============================================================
          Keycloak Admin Credentials
          ============================================================
          URL: http://<masternode-ip>:30180/auth
          Username: admin
          Password: {{ keycloak_admin_password | default('admin123') }}
          ============================================================
      tags: [keycloak]
    
    # Phase 6: Deploy FreeIPA (optional)
    - name: Deploy FreeIPA
      include_role:
        name: identity-freeipa
      tags: [freeipa]
    
    # Phase 6a: Ensure FreeIPA is reachable from cluster nodes
    - name: Ensure FreeIPA uses hostNetwork for node reachability
      include_tasks: tasks/ensure-freeipa-hostnetwork.yml
      tags: [freeipa, freeipa-networking]
    
    # Phase 6b: Conditionally configure firewall if FreeIPA is not reachable
    - name: Check if firewall automation is needed
      when: 
        - freeipa_reachable is defined
        - not (freeipa_reachable | bool)
        - identity_open_firewall | default(false) | bool
      block:
        - name: Attempt to open firewall ports for FreeIPA
          include_tasks: tasks/ensure-freeipa-firewall.yml
          tags: [freeipa, freeipa-firewall]
        
        - name: Re-verify FreeIPA reachability after firewall configuration
          include_tasks: tasks/ensure-freeipa-hostnetwork.yml
          tags: [freeipa, freeipa-networking]
    
    # Phase 6c: Fail if FreeIPA is still not reachable
    - name: Fail if FreeIPA is not reachable and firewall automation is disabled
      fail:
        msg: |
          ============================================================
          FreeIPA is not reachable from cluster nodes!
          ============================================================
          
          FreeIPA has been configured with hostNetwork but connectivity
          verification failed. This may be due to firewall rules blocking
          the required ports.
          
          Required ports: TCP 80,443,389,636,88,464 and UDP 88,464
          FreeIPA Host IP: {{ freeipa_hostip.stdout | default('unknown') }}
          
          Solutions:
          1. Enable automatic firewall configuration by setting:
             identity_open_firewall=true
             Example: ansible-playbook ... -e identity_open_firewall=true
             Or set environment variable: IDENTITY_OPEN_FIREWALL=1
          
          2. Manually configure firewall on the infra node:
             For RHEL/Rocky/AlmaLinux with firewalld:
               firewall-cmd --permanent --add-port={80,443,389,636,88,464}/tcp
               firewall-cmd --permanent --add-port={88,464}/udp
               firewall-cmd --reload
             
             For Debian/Ubuntu with iptables:
               iptables -A INPUT -p tcp -m multiport --dports 80,443,389,636,88,464 -j ACCEPT
               iptables -A INPUT -p udp -m multiport --dports 88,464 -j ACCEPT
               netfilter-persistent save
          
          3. Use a socat proxy as a fallback (see docs/NOTE_FREEIPA_NETWORKING.md)
          
          After resolving connectivity, re-run the deployment or node enrollment.
          ============================================================
      when:
        - freeipa_reachable is defined
        - not (freeipa_reachable | bool)
        - not (identity_open_firewall | default(false) | bool)
    
    # Phase 7: Setup cert-manager and ClusterIssuer
    - name: Setup cert-manager and CA issuer
      include_role:
        name: identity-certmanager
      tags: [certmanager, ca]
    
    # Phase 8: Create administrator account
    - name: Create cluster administrator account
      include_role:
        name: identity-admin
      tags: [admin, credentials]
    
    # Phase 9: Final summary
    - name: Display deployment summary
      debug:
        msg: |
          ============================================================
          Identity Deployment Complete!
          ============================================================
          Infra Node: {{ infra_node }}
          
          Components Deployed:
            - PostgreSQL: Running
            - Keycloak: Running
            - FreeIPA: {{ 'Deployed' if freeipa_manifest_stat is defined and freeipa_manifest_stat.stat.exists else 'Skipped' }}
            - cert-manager: Installed
            - ClusterIssuer: Created
            - TLS Certificates: Deployed for Keycloak, Grafana, Prometheus
            - SSO Configuration: Prepared (requires manual completion)
          
          Access Keycloak:
            Run: kubectl get nodes -o wide
            Then access: http://<node-ip>:30180/auth
          
          Backup Location: /root/identity-backup
          Credentials: /root/identity-backup/cluster-admin-credentials.txt
          SSO Realm Config: /tmp/cluster-realm.json
          
          Next Steps for SSO:
            1. Access Keycloak admin console
            2. Import realm from /tmp/cluster-realm.json
            3. Configure LDAP user federation with FreeIPA
            4. Create OIDC client secrets for Grafana/Prometheus
            5. Deploy FreeIPA LDAP clients to cluster nodes (see playbook comments)
          
          To re-run with destructive replace:
            ansible-playbook {{ playbook_dir }}/identity-deploy-and-handover.yml -e identity_force_replace=true
          ============================================================
      tags: [always]

# Phase 10: Configure FreeIPA LDAP clients on all cluster nodes
# Note: This phase is commented out by default as it requires:
# 1. A running FreeIPA server (deployed in Phase 6)
# 2. Proper network connectivity to FreeIPA from all nodes
# 3. FreeIPA admin credentials
# Uncomment and configure when ready to enable cluster-wide LDAP authentication
#
# - name: Configure FreeIPA LDAP clients on all nodes
#   hosts: all  # Requires inventory with masternode, storagenodet3500, homelab
#   become: true
#   gather_facts: true
#   vars:
#     freeipa_server_hostname: "ipa.vmstation.local"
#     freeipa_domain: "vmstation.local"
#     freeipa_realm: "VMSTATION.LOCAL"
#     freeipa_server_ip: "192.168.4.63"
#     freeipa_admin_password: "{{ lookup('env', 'FREEIPA_ADMIN_PASSWORD') | default('CHANGEME_IPA_ADMIN_PASSWORD') }}"
#   roles:
#     - identity-freeipa-ldap-client
#   tags: [freeipa-client, ldap]
