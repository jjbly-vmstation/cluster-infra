---
- name: Diagnose MetalLB Webhook Issues
  hosts: localhost
  connection: local
  become: true
  gather_facts: false

  vars:
    kubeconfig: /etc/kubernetes/admin.conf
    metallb_namespace: metallb-system

  tasks:
    - name: Get MetalLB pods
      ansible.builtin.command: >
        kubectl --kubeconfig={{ kubeconfig }} get pods -n {{ metallb_namespace }} -o wide
      register: metallb_pods
      changed_when: false

    - name: Display MetalLB pods
      ansible.builtin.debug:
        var: metallb_pods.stdout_lines

    - name: Describe MetalLB webhook service
      ansible.builtin.command: >
        kubectl --kubeconfig={{ kubeconfig }} describe svc -n {{ metallb_namespace }} metallb-webhook-service
      register: metallb_webhook_service
      changed_when: false

    - name: Display MetalLB webhook service
      ansible.builtin.debug:
        var: metallb_webhook_service.stdout_lines

    - name: Get MetalLB controller pod name
      ansible.builtin.command: >
        kubectl --kubeconfig={{ kubeconfig }} get pods -n {{ metallb_namespace }} -l app=metallb,component=controller -o jsonpath='{.items[0].metadata.name}'
      register: metallb_controller_pod_name
      changed_when: false

    - name: Get MetalLB controller logs
      ansible.builtin.command: >
        kubectl --kubeconfig={{ kubeconfig }} logs -n {{ metallb_namespace }} {{ metallb_controller_pod_name.stdout }}
      register: metallb_controller_logs
      changed_when: false
      when: metallb_controller_pod_name.stdout != ""

    - name: Display MetalLB controller logs
      ansible.builtin.debug:
        var: metallb_controller_logs.stdout_lines
      when: metallb_controller_pod_name.stdout != ""

    - name: Get MetalLB ValidatingWebhookConfiguration
      ansible.builtin.command: >
        kubectl --kubeconfig={{ kubeconfig }} get validatingwebhookconfigurations -l app.kubernetes.io/instance=metallb -o yaml
      register: metallb_webhook_config
      changed_when: false

    - name: Display MetalLB ValidatingWebhookConfiguration
      ansible.builtin.debug:
        var: metallb_webhook_config.stdout_lines
