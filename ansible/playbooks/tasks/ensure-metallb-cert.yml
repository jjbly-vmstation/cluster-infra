---
# Task: Ensure MetalLB Webhook Certificate exists using cert-manager and FreeIPA CA
# Replaces manual openssl generation with proper infrastructure-managed certificates.

- name: Create MetalLB webhook certificate manifest (cert-manager)
  ansible.builtin.copy:
    dest: "/tmp/metallb-cert-manager.yaml"
    content: |
      apiVersion: cert-manager.io/v1
      kind: Certificate
      metadata:
        name: metallb-webhook-cert
        namespace: metallb-system
      spec:
        secretName: metallb-webhook-cert
        duration: 8760h # 1 year
        renewBefore: 240h # 10 days
        subject:
          organizations:
            - vmstation
        commonName: metallb-webhook-service.metallb-system.svc
        dnsNames:
          - metallb-webhook-service.metallb-system.svc
          - metallb-webhook-service.metallb-system.svc.cluster.local
        issuerRef:
          name: freeipa-ca
          kind: ClusterIssuer
          group: cert-manager.io

- name: Apply MetalLB Certificate
  ansible.builtin.command: >
    kubectl --kubeconfig={{ kubeconfig }} apply -f /tmp/metallb-cert-manager.yaml
  register: apply_cert
  changed_when: "'created' in apply_cert.stdout or 'configured' in apply_cert.stdout"

- name: Wait for MetalLB webhook secret to be generated by cert-manager
  ansible.builtin.command: >
    kubectl --kubeconfig={{ kubeconfig }} -n metallb-system get secret metallb-webhook-cert
  register: wait_for_secret
  until: wait_for_secret.rc == 0
  retries: 60
  delay: 5