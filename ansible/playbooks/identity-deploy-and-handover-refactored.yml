---
# Playbook: identity-deploy-and-handover.yml (Refactored)
# Purpose: Deploy FreeIPA, Keycloak, PostgreSQL, cert-manager with modular roles
# This playbook has been refactored to use roles for better modularity and maintainability.
#
# The control-plane taint issue has been resolved by ensuring all StatefulSets
# have appropriate tolerations for node-role.kubernetes.io/control-plane:NoSchedule.

- name: Deploy identity stack and hand over CA to cert-manager
  hosts: localhost
  connection: local
  gather_facts: true
  
  vars:
    # Repository root path (auto-detect from playbook location)
    repo_root: "{{ playbook_dir | dirname | dirname }}"
    
    # Control behavior
    identity_force_replace: false
    identity_backup_before_replace: true
    
  tasks:
    # Phase 1: Prerequisites
    - name: Run identity prerequisites
      include_role:
        name: identity-prerequisites
      tags: [prerequisites, always]
    
    # Phase 2: Optional backup before destructive replace
    - name: Backup existing identity data before replace
      include_role:
        name: identity-backup
      when: identity_force_replace | default(false) | bool and identity_backup_before_replace | default(true) | bool
      tags: [backup]
    
    # Phase 3: Storage setup
    - name: Setup identity storage
      include_role:
        name: identity-storage
      tags: [storage]
    
    # Phase 4: Deploy PostgreSQL
    - name: Deploy PostgreSQL for Keycloak
      include_role:
        name: identity-postgresql
      tags: [postgresql, database]
    
    # Phase 5: Deploy Keycloak
    - name: Deploy Keycloak via Helm
      include_role:
        name: identity-keycloak
      tags: [keycloak]
    
    # Phase 6: Deploy FreeIPA (optional)
    - name: Deploy FreeIPA
      include_role:
        name: identity-freeipa
      tags: [freeipa]
    
    # Phase 7: Setup cert-manager and ClusterIssuer
    - name: Setup cert-manager and CA issuer
      include_role:
        name: identity-certmanager
      tags: [certmanager, ca]
    
    # Phase 8: Final summary
    - name: Display deployment summary
      debug:
        msg: |
          ============================================================
          Identity Deployment Complete!
          ============================================================
          Infra Node: {{ infra_node }}
          
          Components Deployed:
            - PostgreSQL: Running
            - Keycloak: Running
            - FreeIPA: {{ 'Deployed' if freeipa_manifest_stat is defined and freeipa_manifest_stat.stat.exists else 'Skipped' }}
            - cert-manager: Installed
            - ClusterIssuer: Created
          
          Access Keycloak:
            Run: kubectl get nodes -o wide
            Then access: http://<node-ip>:30080/auth
          
          Backup Location: /root/identity-backup
          
          To re-run with destructive replace:
            ansible-playbook {{ playbook_dir }}/identity-deploy-and-handover.yml -e identity_force_replace=true
          ============================================================
      tags: [always]
