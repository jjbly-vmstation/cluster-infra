---
- name: Detect kube-proxy configured mode (control host)
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Read kube-proxy config.conf from ConfigMap
      shell: kubectl -n kube-system get configmap kube-proxy -o jsonpath='{.data.config\.conf}'
      register: kubeproxy_conf
      changed_when: false
      failed_when: kubeproxy_conf.rc != 0 and kubeproxy_conf.rc is not none

    - name: Detect kube-proxy mode
      set_fact:
        kubeproxy_mode: >-
          {{
            (kubeproxy_conf.stdout | regex_search('mode:\s*"?([a-zA-Z0-9_\\-]+)"?', '\\1')) | default('')
          }}

    - name: Debug kube-proxy mode
      debug:
        msg: "kube-proxy configured mode: '{{ kubeproxy_mode | default('UNKNOWN') }}'"

- name: Ensure ipvs state is consistent with kube-proxy mode (all nodes)
  hosts: all
  become: yes
  gather_facts: no
  vars:
    ipvs_loaded_cmd: "lsmod | awk '/^ip_vs/ {print $1}' || true"
  tasks:
    - name: Check whether ip_vs module is loaded
      shell: "{{ ipvs_loaded_cmd }}"
      register: ipvs_module
      changed_when: false
      ignore_errors: true

    - name: Decide whether to clear IPVS on this host
      set_fact:
        clear_ipvs_needed: "{{ (hostvars['localhost'].kubeproxy_mode | default('')) == 'iptables' and (ipvs_module.stdout | trim) != '' }}"

    - name: Show whether clearing ipvs is needed
      debug:
        msg: "Host={{ inventory_hostname }} clear_ipvs_needed={{ clear_ipvs_needed }} ip_vs_loaded='{{ ipvs_module.stdout | trim }}'"

    - name: Ensure ipvsadm present (best-effort) when clearing is needed
      package:
        name: ipvsadm
        state: present
      when: clear_ipvs_needed
      register: ipvsadm_pkg
      ignore_errors: true

    - name: Show ipvsadm path (best-effort)
      shell: "command -v ipvsadm || true"
      when: clear_ipvs_needed
      register: ipvsadm_path
      changed_when: false

    - name: Flush IPVS table on host (ipvsadm -C) when needed
      when: clear_ipvs_needed
      shell: |
        if command -v ipvsadm >/dev/null 2>&1; then
          echo "Before ipvsadm -Ln:"
          ipvsadm -Ln || true
          echo "Clearing IPVS table..."
          ipvsadm -C
          echo "After ipvsadm -Ln:"
          ipvsadm -Ln || true
        else
          echo "ipvsadm not present; cannot clear ipvs on this host"
          exit 0
        fi
      register: ipvs_clear
      changed_when: ipvs_clear.rc == 0 and "'ipvsadm not present' not in ipvs_clear.stdout"
      failed_when: ipvs_clear.rc != 0 and "'ipvsadm not present' not in ipvs_clear.stdout"

    - name: Debug ipvs clear stdout (when attempted)
      debug:
        var: ipvs_clear.stdout_lines
      when: clear_ipvs_needed

- name: Restart kube-proxy DaemonSet (control host)
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Restart kube-proxy DaemonSet (rollout restart)
      shell: kubectl -n kube-system rollout restart ds/kube-proxy
      register: ds_restart
      changed_when: ds_restart.rc == 0
      failed_when: ds_restart.rc != 0

    - name: Wait for kube-proxy rollout to complete
      shell: kubectl -n kube-system rollout status ds/kube-proxy --timeout=180s
      register: rollout_status
      failed_when: rollout_status.rc != 0
      changed_when: false

    - name: Show short kube-proxy logs for verification
      shell: |
        POD=$(kubectl -n kube-system get pods -l k8s-app=kube-proxy -o jsonpath='{.items[0].metadata.name}')
        kubectl -n kube-system logs "${POD}" --tail=120 || true
      register: kubeproxy_logs
      changed_when: false
      failed_when: false

    - name: Debug kube-proxy logs snippet
      debug:
        var: kubeproxy_logs.stdout_lines
      changed_when: false
