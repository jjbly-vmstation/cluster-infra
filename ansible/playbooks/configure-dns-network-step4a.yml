---
# Playbook: configure-dns-network-step4a.yml
# Purpose: Automate Step 4a - Configure DNS Records and Network Ports for FreeIPA/Keycloak
# This playbook should be run after the identity stack deployment (Steps 1-3)

- name: Step 4a - Configure DNS Records and Network Ports
  hosts: all
  gather_facts: true
  become: true
  
  vars:
    # Repository root path
    repo_root: "{{ playbook_dir | dirname | dirname }}"
    
    # Configuration paths
    kubeconfig_path: /etc/kubernetes/admin.conf
    identity_namespace: identity
    freeipa_pod_name: freeipa-0
    dns_records_dir: /tmp/freeipa-dns-records
    
    # FreeIPA/Keycloak configuration
    freeipa_hostname: ipa.vmstation.local
    freeipa_ip: 192.168.4.63
    masternode_ip: 192.168.4.63
    
    # Network ports to configure
    tcp_ports: [22, 80, 443, 389, 636, 88, 464, 53]
    udp_ports: [88, 464, 53]
    
    # Cluster subnets
    cluster_subnets:
      - 192.168.4.0/24    # Physical network
      - 10.244.0.0/16     # Pod network (Flannel)
      - 10.96.0.0/12      # Service network

  tasks:
    # =========================================================================
    # Phase 1: Extract DNS Records (run on control-plane only)
    # =========================================================================
    - name: Phase 1 - Extract DNS Records from FreeIPA
      block:
        - name: Check if kubectl is available
          ansible.builtin.command: which kubectl
          register: kubectl_check
          changed_when: false
          failed_when: false
          
        - name: Check if FreeIPA pod exists
          ansible.builtin.command: >
            kubectl --kubeconfig={{ kubeconfig_path }}
            -n {{ identity_namespace }}
            get pod {{ freeipa_pod_name }}
          register: freeipa_pod_check
          changed_when: false
          failed_when: false
          when: kubectl_check.rc == 0
          
        - name: Extract DNS records from FreeIPA pod
          ansible.builtin.script: "{{ repo_root }}/scripts/extract-freeipa-dns-records.sh -v"
          register: dns_extraction
          when:
            - kubectl_check.rc == 0
            - freeipa_pod_check is defined
            - freeipa_pod_check.rc == 0
          changed_when: true
          
        - name: Display DNS extraction results
          ansible.builtin.debug:
            msg: "{{ dns_extraction.stdout_lines }}"
          when: dns_extraction is defined and dns_extraction.changed
          
      when: inventory_hostname == groups['kube_control_plane'][0] | default(groups['kube-master'][0]) | default('masternode')
      tags: [dns, extract]

    # =========================================================================
    # Phase 2: Distribute DNS Records to All Nodes
    # =========================================================================
    - name: Phase 2 - Configure DNS Records on All Nodes
      block:
        - name: Ensure DNS records directory exists
          ansible.builtin.file:
            path: "{{ dns_records_dir }}"
            state: directory
            mode: '0755'
            
        - name: Create FreeIPA hosts file
          ansible.builtin.copy:
            dest: "{{ dns_records_dir }}/freeipa-hosts.txt"
            content: |
              # FreeIPA DNS Records - Generated by Ansible
              # Date: {{ ansible_date_time.iso8601 }}
              
              {{ freeipa_ip }}    {{ freeipa_hostname }} ipa
              {{ freeipa_ip }}    vmstation.local
            mode: '0644'
            
        - name: Backup existing /etc/hosts
          ansible.builtin.copy:
            src: /etc/hosts
            dest: /etc/hosts.pre-freeipa
            remote_src: true
            mode: '0644'
          when: not ansible_check_mode
          
        - name: Remove old FreeIPA entries from /etc/hosts
          ansible.builtin.lineinfile:
            path: /etc/hosts
            regexp: '.*{{ freeipa_hostname }}.*'
            state: absent
          
        - name: Remove old vmstation.local entries from /etc/hosts
          ansible.builtin.lineinfile:
            path: /etc/hosts
            regexp: '.*vmstation\.local.*'
            state: absent
            
        - name: Add FreeIPA DNS records to /etc/hosts
          ansible.builtin.blockinfile:
            path: /etc/hosts
            block: |
              # FreeIPA DNS Records - Managed by Ansible
              {{ freeipa_ip }}    {{ freeipa_hostname }} ipa
              {{ freeipa_ip }}    vmstation.local
            marker: "# {mark} FREEIPA DNS RECORDS"
            
        - name: Verify DNS resolution
          ansible.builtin.command: getent hosts {{ freeipa_hostname }}
          register: dns_verify
          changed_when: false
          failed_when: false
          
        - name: Display DNS verification result
          ansible.builtin.debug:
            msg: "✓ DNS resolution successful: {{ dns_verify.stdout }}"
          when: dns_verify.rc == 0
          
      tags: [dns, configure]

    # =========================================================================
    # Phase 3: Configure Firewall Rules
    # =========================================================================
    - name: Phase 3 - Configure Network Ports
      block:
        - name: Detect firewall system
          ansible.builtin.set_fact:
            firewall_system: >-
              {%- if ansible_os_family == 'RedHat' -%}
              firewalld
              {%- elif ansible_os_family == 'Debian' -%}
              iptables
              {%- else -%}
              none
              {%- endif -%}
              
        - name: Display detected firewall system
          ansible.builtin.debug:
            msg: "Detected firewall system: {{ firewall_system }}"
            
        # Firewalld configuration (RHEL/CentOS)
        - name: Configure firewalld (RHEL/CentOS)
          block:
            - name: Ensure firewalld is running
              ansible.builtin.systemd:
                name: firewalld
                state: started
                enabled: true
              when: ansible_service_mgr == 'systemd'
              
            - name: Get active firewalld zone
              ansible.builtin.command: firewall-cmd --get-active-zones
              register: active_zones
              changed_when: false
              
            - name: Set firewall zone
              ansible.builtin.set_fact:
                firewall_zone: "{{ active_zones.stdout_lines[0] | default('public') }}"
                
            - name: Configure TCP ports in firewalld
              ansible.posix.firewalld:
                port: "{{ item }}/tcp"
                permanent: true
                state: enabled
                zone: "{{ firewall_zone }}"
                immediate: true
              loop: "{{ tcp_ports }}"
              
            - name: Configure UDP ports in firewalld
              ansible.posix.firewalld:
                port: "{{ item }}/udp"
                permanent: true
                state: enabled
                zone: "{{ firewall_zone }}"
                immediate: true
              loop: "{{ udp_ports }}"
              
            - name: Add common services to firewalld
              ansible.posix.firewalld:
                service: "{{ item }}"
                permanent: true
                state: enabled
                zone: "{{ firewall_zone }}"
                immediate: true
              loop:
                - ssh
                - http
                - https
                - ldap
                - ldaps
                - kerberos
                - dns
              ignore_errors: true
              
            - name: Trust cluster subnets in firewalld
              ansible.posix.firewalld:
                source: "{{ item }}"
                permanent: true
                state: enabled
                zone: "{{ firewall_zone }}"
                immediate: true
              loop: "{{ cluster_subnets }}"
              ignore_errors: true
              
          when: firewall_system == 'firewalld'
          
        # Iptables configuration (Debian/Ubuntu)
        - name: Configure iptables (Debian/Ubuntu)
          block:
            - name: Install iptables-persistent
              ansible.builtin.apt:
                name: iptables-persistent
                state: present
                update_cache: true
              when: ansible_os_family == 'Debian'
              
            - name: Allow TCP ports in iptables
              ansible.builtin.iptables:
                chain: INPUT
                protocol: tcp
                destination_port: "{{ item }}"
                jump: ACCEPT
                comment: "Allow {{ item }}/tcp for FreeIPA/Keycloak"
              loop: "{{ tcp_ports }}"
              
            - name: Allow UDP ports in iptables
              ansible.builtin.iptables:
                chain: INPUT
                protocol: udp
                destination_port: "{{ item }}"
                jump: ACCEPT
                comment: "Allow {{ item }}/udp for Kerberos/DNS"
              loop: "{{ udp_ports }}"
              
            - name: Allow established connections
              ansible.builtin.iptables:
                chain: INPUT
                ctstate: ESTABLISHED,RELATED
                jump: ACCEPT
                
            - name: Allow loopback traffic
              ansible.builtin.iptables:
                chain: INPUT
                in_interface: lo
                jump: ACCEPT
                
            - name: Allow cluster subnets
              ansible.builtin.iptables:
                chain: INPUT
                source: "{{ item }}"
                jump: ACCEPT
                comment: "Allow cluster subnet {{ item }}"
              loop: "{{ cluster_subnets }}"
              
            - name: Save iptables rules
              ansible.builtin.shell: |
                iptables-save > /etc/iptables/rules.v4
              args:
                executable: /bin/bash
              changed_when: true
              when: ansible_os_family == 'Debian'
              
          when: firewall_system == 'iptables'
          
      tags: [firewall, network]

    # =========================================================================
    # Phase 4: Verification
    # =========================================================================
    - name: Phase 4 - Verify Configuration
      block:
        - name: Verify DNS resolution
          ansible.builtin.command: getent hosts {{ freeipa_hostname }}
          register: final_dns_check
          changed_when: false
          failed_when: false
          
        - name: Test SSH port accessibility
          ansible.builtin.wait_for:
            host: "{{ masternode_ip }}"
            port: 22
            timeout: 10
          delegate_to: localhost
          ignore_errors: true
          
        - name: Test FreeIPA HTTP port
          ansible.builtin.wait_for:
            host: "{{ masternode_ip }}"
            port: 30088
            timeout: 10
          delegate_to: localhost
          ignore_errors: true
          
        - name: Test Keycloak HTTP port
          ansible.builtin.wait_for:
            host: "{{ masternode_ip }}"
            port: 30180
            timeout: 10
          delegate_to: localhost
          ignore_errors: true
          
        - name: Display verification summary
          ansible.builtin.debug:
            msg:
              - "============================================"
              - "Step 4a Configuration Summary"
              - "============================================"
              - "✓ DNS records configured on {{ inventory_hostname }}"
              - "✓ Firewall rules configured ({{ firewall_system }})"
              - "✓ DNS resolution: {{ final_dns_check.stdout | default('Not verified') }}"
              - ""
              - "Access Points:"
              - "  FreeIPA:  https://{{ freeipa_hostname }}:30445/ipa/ui"
              - "  Keycloak: http://{{ masternode_ip }}:30180/auth/"
              - "============================================"
              
      tags: [verify, always]

  handlers:
    - name: Reload firewalld
      ansible.builtin.systemd:
        name: firewalld
        state: reloaded
      when: ansible_service_mgr == 'systemd'
      
    - name: Reload iptables
      ansible.builtin.command: iptables-restore < /etc/iptables/rules.v4
      when: ansible_os_family == 'Debian'
      changed_when: true
