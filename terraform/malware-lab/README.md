# Malware Analysis Lab - Terraform Infrastructure

## Overview

This Terraform configuration deploys an isolated malware analysis laboratory environment for security research and training. The lab provides a controlled environment for analyzing potentially malicious software with enterprise-grade security infrastructure.

## âš ï¸ Security Warning

**This infrastructure is designed for malware analysis and contains potentially dangerous isolated environments.**

- **Complete network isolation** from production VMStation cluster
- **No internet access** from malware analysis VMs by default
- **Snapshot-based rollback** for quick recovery
- **Encrypted storage** for malware samples
- **Automated cleanup** after analysis sessions

## Architecture

### Network Topology

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Isolated Lab Network                        â”‚
â”‚                     (10.200.0.0/16)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   Windows    â”‚  â”‚   Windows    â”‚  â”‚    Rocky     â”‚        â”‚
â”‚  â”‚   Server     â”‚  â”‚   Server     â”‚  â”‚   Linux 9    â”‚        â”‚
â”‚  â”‚    2019      â”‚  â”‚    2022      â”‚  â”‚              â”‚        â”‚
â”‚  â”‚ 10.200.10.10 â”‚  â”‚ 10.200.10.11 â”‚  â”‚ 10.200.20.10 â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   AlmaLinux  â”‚  â”‚   Oracle     â”‚  â”‚   Cisco      â”‚        â”‚
â”‚  â”‚      9       â”‚  â”‚   Linux 9    â”‚  â”‚   Switch     â”‚        â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚   (GNS3)     â”‚        â”‚
â”‚  â”‚ 10.200.20.11 â”‚  â”‚ 10.200.20.12 â”‚  â”‚ 10.200.1.1   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Security & Monitoring Layer                  â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ IDS/IPS  â”‚  â”‚ RKE2 +   â”‚  â”‚ CoreDNS  â”‚  â”‚ Kerberosâ”‚ â”‚ â”‚
â”‚  â”‚  â”‚ Suricata â”‚  â”‚ Splunk   â”‚  â”‚ + DHCP   â”‚  â”‚   KDC   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚         â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚ â”‚
â”‚  â”‚  â”‚    AD    â”‚  â”‚   PKI    â”‚                              â”‚ â”‚
â”‚  â”‚  â”‚    DC    â”‚  â”‚   CA     â”‚                              â”‚ â”‚
â”‚  â”‚  â”‚          â”‚  â”‚          â”‚                              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Firewall / NAT
                              â”‚ (Management Only)
                              â–¼
                     homelab (192.168.4.62)
                        RHEL10 Host
```

### VLAN Segmentation

- **VLAN 10:** Windows Servers (10.200.10.0/24)
- **VLAN 20:** Linux Servers (10.200.20.0/24)
- **VLAN 30:** Security Services (10.200.30.0/24)
- **VLAN 1:** Management Network (10.200.1.0/24)

## Components

### 1. Windows Server VMs
- **Windows Server 2019** - Legacy application testing
- **Windows Server 2022** - Modern malware behavior analysis
- Features: Active Directory integration, isolated domain

### 2. Enterprise Linux VMs
- **Rocky Linux 9** - RHEL-compatible enterprise testing
- **AlmaLinux 9** - Alternative RHEL-compatible distribution
- **Oracle Linux 9** - Oracle-specific testing
- Features: SELinux enabled, minimal attack surface

### 3. Network Infrastructure
- **Cisco Switch Simulation** - GNS3/EVE-NG integration
- **VLAN Isolation** - Prevents lateral movement
- **Traffic Mirroring** - All traffic captured for analysis

### 4. Security Solutions
- **IDS/IPS:** Suricata with ET rules
- **Network Tap:** Full packet capture
- **SSL/TLS Inspection:** Decrypt encrypted traffic

### 5. Logging & SIEM
- **RKE2 Cluster:** Lightweight Kubernetes for Splunk
- **Splunk Enterprise:** Free tier (500MB/day)
- **Log Forwarding:** All VMs send logs to Splunk
- **Dashboards:** Pre-configured SIEM templates

### 6. Enterprise Services
- **CoreDNS:** Lab DNS server
- **DHCP:** Automated IP assignment
- **Kerberos KDC:** Authentication testing
- **Active Directory:** Windows domain controller
- **PKI/CA:** Certificate infrastructure
- **LDAP:** Directory services

## Resource Requirements

### Minimum Specifications
- **CPU:** 16 cores (32 threads recommended)
- **RAM:** 64 GB (128 GB recommended)
- **Storage:** 500 GB SSD (1 TB recommended)
- **Network:** 2 NICs (1 management, 1 isolated)

### Recommended Allocation per VM
| Component | vCPU | RAM | Storage |
|-----------|------|-----|---------|
| Windows Server 2019 | 2 | 4 GB | 60 GB |
| Windows Server 2022 | 2 | 4 GB | 60 GB |
| Rocky Linux 9 | 2 | 2 GB | 30 GB |
| AlmaLinux 9 | 2 | 2 GB | 30 GB |
| Oracle Linux 9 | 2 | 2 GB | 30 GB |
| Suricata IDS | 4 | 8 GB | 100 GB |
| RKE2 + Splunk | 4 | 16 GB | 200 GB |
| CoreDNS + DHCP | 1 | 1 GB | 10 GB |
| Kerberos KDC | 1 | 2 GB | 20 GB |
| AD Domain Controller | 2 | 4 GB | 40 GB |
| PKI CA | 1 | 2 GB | 20 GB |

**Total:** 25 vCPU, 49 GB RAM, 600 GB Storage

## Deployment Workflow

### Phase 1: Infrastructure Setup
1. Initialize Terraform workspace
2. Configure provider (libvirt/VMware/Proxmox)
3. Create isolated network bridges
4. Deploy VLAN configuration

### Phase 2: Base VMs
1. Deploy Windows Server 2019
2. Deploy Windows Server 2022
3. Deploy Rocky Linux 9
4. Deploy AlmaLinux 9
5. Deploy Oracle Linux 9

### Phase 3: Security Infrastructure
1. Deploy Suricata IDS/IPS
2. Configure traffic mirroring
3. Deploy network tap

### Phase 4: Enterprise Services
1. Deploy Active Directory Domain Controller
2. Deploy CoreDNS + DHCP server
3. Deploy Kerberos KDC
4. Deploy PKI Certificate Authority
5. Configure LDAP integration

### Phase 5: Monitoring & SIEM
1. Deploy RKE2 cluster
2. Deploy Splunk Enterprise
3. Configure log forwarding from all VMs
4. Import SIEM dashboard templates
5. Configure alerts and notifications

### Phase 6: Testing & Validation
1. Verify network isolation
2. Test malware detonation in sandbox
3. Validate log collection
4. Test snapshot rollback
5. Verify no internet access from VMs

## Usage

### Quick Start

```bash
cd terraform/malware-lab/environments/dev
terraform init
terraform plan
terraform apply
```

### Accessing Components

**Management Network (from homelab host):**
```bash
# SSH to Linux VMs
ssh admin@10.200.20.10  # Rocky Linux
ssh admin@10.200.20.11  # AlmaLinux
ssh admin@10.200.20.12  # Oracle Linux

# RDP to Windows VMs
xfreerdp /v:10.200.10.10 /u:Administrator  # Windows 2019
xfreerdp /v:10.200.10.11 /u:Administrator  # Windows 2022

# Access Splunk
https://10.200.30.10:8000  # Splunk Web UI
```

**Monitoring:**
```bash
# Suricata alerts
tail -f /var/log/suricata/fast.log

# Splunk search
# Access via Web UI at https://10.200.30.10:8000
```

### Destroying the Lab

**Complete teardown:**
```bash
terraform destroy
```

**Selective destruction:**
```bash
# Destroy only malware analysis VMs
terraform destroy -target=module.windows-server
terraform destroy -target=module.linux-enterprise
```

## Security Best Practices

1. **Never connect to production networks**
2. **Always use snapshots before analysis**
3. **Encrypt all malware samples**
4. **Review firewall rules regularly**
5. **Monitor all network traffic**
6. **Automate cleanup after sessions**
7. **Keep host system patched**
8. **Use strong passwords**

## Troubleshooting

### Common Issues

**VMs not getting DHCP addresses:**
```bash
# Check DHCP server logs
ssh dhcp-server
journalctl -u dnsmasq -f
```

**Network isolation broken:**
```bash
# Verify iptables rules on homelab host
iptables -L -n -v | grep 10.200
```

**Splunk not receiving logs:**
```bash
# Check Splunk forwarder on VM
systemctl status splunkforwarder
/opt/splunkforwarder/bin/splunk list forward-server
```

## Future Enhancements

- [ ] Automated malware detonation pipeline
- [ ] Integration with MISP threat intelligence
- [ ] Automated IOC extraction
- [ ] Machine learning-based anomaly detection
- [ ] REMnux integration for reverse engineering
- [ ] YARA rule testing framework
- [ ] Cuckoo Sandbox integration

## References

- [Splunk Free License](https://www.splunk.com/en_us/software/splunk-enterprise.html)
- [Suricata IDS Documentation](https://suricata.readthedocs.io/)
- [GNS3 Documentation](https://docs.gns3.com/)
- [RKE2 Documentation](https://docs.rke2.io/)

---

**Status:** ğŸ“‹ TODO - Scaffolding Created  
**Target Deployment:** homelab node (192.168.4.62)  
**Estimated Build Time:** 4-6 hours (full deployment)  
**Last Updated:** January 2025
